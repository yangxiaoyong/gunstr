<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>7.&nbsp;Classful Queuing Disciplines (qdiscs)</title><meta name="generator" content="DocBook XSL Stylesheets V1.69.0"><link rel="start" href="http://linux-ip.net/articles/Traffic-Control-HOWTO/index.html" title="Traffic Control HOWTO"><link rel="up" href="http://linux-ip.net/articles/Traffic-Control-HOWTO/index.html" title="Traffic Control HOWTO"><link rel="prev" href="http://linux-ip.net/articles/Traffic-Control-HOWTO/classless-qdiscs.html" title="6.&nbsp;Classless Queuing Disciplines (qdiscs)"><link rel="next" href="http://linux-ip.net/articles/Traffic-Control-HOWTO/rules.html" title="8.&nbsp;Rules, Guidelines and Approaches"><meta xmlns="http://www.w3.org/TR/xhtml1/transitional" name="generator" content="Experimental LDP.XSL $Revision: 1.2 $">
  <!-- Generated by LDP XSLT customization layer
      based on Norman Walsh's DocBook XSL stylesheets.
      More information at http://www.linuxdoc.org/ -->
  
<link rel="stylesheet" type="text/css" href="classful-qdiscs.css" media="all">
</head>
<body><div class="navheader"><table summary="Navigation header" width="100%"><tbody><tr><th colspan="3" align="center">7.&nbsp;Classful Queuing Disciplines (<code class="constant">qdisc</code>s)</th></tr><tr><td width="20%" align="left"><a indepth="true" accesskey="p" href="classless-qdiscs.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a indepth="true" accesskey="n" href="rules.html">Next</a></td></tr></tbody></table><hr></div><div class="section" xml:lang="en" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both;"><a id="classful-qdiscs"></a>7.&nbsp;Classful Queuing Disciplines (<a indepth="true" href="components.html#c-qdisc" title="4.1.&nbsp;qdisc"><code class="constant">qdisc</code></a>s)</h2></div></div></div><p>
    The flexibility and control of Linux traffic control can be unleashed
    through the agency of the classful qdiscs.  Remember that the classful
    queuing disciplines can have filters attached to them, allowing packets to
    be directed to particular classes and subqueues.
  </p><p>
    There are several common terms to describe classes directly attached to
    the <code class="constant">root</code> qdisc and terminal classes.  Classess attached to the
    <code class="constant">root</code> qdisc are known as root classes, and more generically inner
    classes.  Any terminal class in a particular queuing discipline is known
    as a leaf class by analogy to the tree structure of the classes.  Besides
    the use of figurative language depicting the structure as a tree, the
    language of family relationships is also quite common.
  </p><div class="section" xml:lang="en" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="qc-htb"></a>7.1.&nbsp;HTB, Hierarchical Token Bucket</h3></div></div></div><p>
      HTB uses the concepts of tokens and buckets
      along with the class-based system and <a indepth="true" href="components.html#c-filter" title="4.3.&nbsp;filter"><code class="constant">filter</code></a>s to allow for
      complex and granular control over traffic.  With a complex
      <a indepth="true" href="classful-qdiscs.html#qc-htb-borrowing" title="7.1.3.&nbsp;Borrowing">borrowing model</a>, HTB can perform a variety of sophisticated
      traffic control techniques.  One of the easiest ways to use HTB
      immediately is that of <a indepth="true" href="classful-qdiscs.html#qc-htb-borrowing" title="7.1.3.&nbsp;Borrowing">shaping</a>.
    </p><p>
      By understanding <a indepth="true" href="overview.html#o-tokens" title="2.7.&nbsp;Tokens and buckets">tokens</a> and <a indepth="true" href="overview.html#o-buckets">buckets</a> or by grasping
      the function of <a indepth="true" href="classless-qdiscs.html#qs-tbf" title="6.6.&nbsp;TBF, Token Bucket Filter">TBF</a>, HTB should be merely a logical
      step.  This queuing discipline allows the user to define the
      characteristics of the tokens and bucket used and allows the user to
      nest these buckets in an arbitrary fashion.  When coupled with a
      <a indepth="true" href="elements.html#e-classifying" title="3.3.&nbsp;Classifying">classifying</a> scheme, traffic can be controlled in a very
      granular fashion.
    </p><p>
    </p><p>
      Below is example output of the syntax for HTB on the command line
      with the <a indepth="true" href="software.html#s-iproute2-tc"><span><strong class="command">tc</strong></span></a> tool.  Although the syntax for <a indepth="true" href="software.html#s-tcng" title="5.3.&nbsp;tcng, Traffic Control Next Generation"><span><strong class="command">tcng</strong></span></a> is a
      language of its own, the rules for HTB are the same.
    </p><div class="example"><a id="ex-qc-htb-usage"></a><p class="title"><b>Example&nbsp;10.&nbsp;<span>tc</span> usage for HTB</b></p><table xmlns="http://www.w3.org/TR/xhtml1/transitional" bgcolor="#E0E0E0" border="0" width="90%"><tbody><tr><td><pre class="programlisting">Usage: ... qdisc add ... htb [default N] [r2q N]
 default  minor id of class to which unclassified packets are sent {0}
 r2q      DRR quantums are computed as rate in Bps/r2q {10}
 debug    string of 16 numbers each 0-3 {0}

... class add ... htb rate R1 burst B1 [prio P] [slot S] [pslot PS]
                      [ceil R2] [cburst B2] [mtu MTU] [quantum Q]
 rate     rate allocated to this class (class can still borrow)
 burst    max bytes burst which can be accumulated during idle period {computed}
 ceil     definite upper class rate (no borrows) {rate}
 cburst   burst but for ceil {computed}
 mtu      max packet size we create rate map for {1600}
 prio     priority of leaf; lower are served first {0}
 quantum  how much bytes to serve from leaf at once {use r2q}

TC HTB version 3.3
      </pre></td></tr></tbody></table></div><p>
    </p><div class="section" xml:lang="en" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="qc-htb-software"></a>7.1.1.&nbsp;Software requirements</h4></div></div></div><p>
        Unlike almost all of the other software discussed, HTB is a
        newer queuing discipline and your distribution may not have all of the
        tools and capability you need to use HTB.  The kernel must
        support HTB; kernel version 2.4.20 and later support it in the
        stock distribution, although earlier kernel versions require patching.
        To enable userland support for HTB, see <a xmlns="http://www.w3.org/TR/xhtml1/transitional" class="nonlocal" href="http://luxik.cdi.cz/%7Edevik/qos/htb/" target="_top">HTB</a> for an
        <span><strong class="command">iproute2</strong></span> patch to <span><strong class="command">tc</strong></span>.
      </p></div><div class="section" xml:lang="en" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="qc-htb-shaping"></a>7.1.2.&nbsp;Shaping</h4></div></div></div><p>
        One of the most common applications of HTB involves shaping
        transmitted traffic to a specific rate.
      </p><p>
        All shaping occurs in leaf classes.  No shaping occurs in inner or
        root classes as they only exist to suggest how the
        <a indepth="true" href="classful-qdiscs.html#qc-htb-borrowing" title="7.1.3.&nbsp;Borrowing">borrowing model</a> should distribute available tokens.
      </p><p>
      </p><p>
      </p></div><div class="section" xml:lang="en" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="qc-htb-borrowing"></a>7.1.3.&nbsp;Borrowing</h4></div></div></div><p>
        A fundamental part of the HTB qdisc is the borrowing mechanism.
        Children classes borrow tokens from their parents once they have
        exceeded <a indepth="true" href="classful-qdiscs.html#vl-qc-htb-params-rate"><em class="parameter"><code>rate</code></em></a>.  A child class will continue to
        attempt to borrow until it reaches <a indepth="true" href="classful-qdiscs.html#vl-qc-htb-params-ceil"><em class="parameter"><code>ceil</code></em></a>, at which
        point it will begin to queue packets for transmission until more
        tokens/ctokens are available.  As there are only two primary types of
        classes which can be created with HTB the following table and
        diagram identify the various possible states and the behaviour of the
        borrowing mechanisms.
      </p><p>
      </p><div class="table"><a id="tb-qc-htb-borrowing"></a><p class="title"><b>Table&nbsp;2.&nbsp;HTB class states and potential actions taken</b></p><table summary="HTB class states and potential actions taken" border="1"><colgroup><col><col><col><col></colgroup><thead><tr><th align="left">type of class</th><th align="left">class state</th><th align="left">HTB internal state</th><th align="left">action taken</th></tr></thead><tbody><tr><td align="left">leaf</td><td align="left">&lt; <em class="parameter"><code>rate</code></em></td><td align="left"><em class="parameter"><code>HTB_CAN_SEND</code></em></td><td align="left">
                Leaf class will dequeue queued bytes up
                to available tokens (no more than burst packets)
              </td></tr><tr><td align="left">leaf</td><td align="left">&gt; <em class="parameter"><code>rate</code></em>, &lt; <em class="parameter"><code>ceil</code></em></td><td align="left"><em class="parameter"><code>HTB_MAY_BORROW</code></em></td><td align="left">
                Leaf class will attempt to borrow tokens/ctokens from
                parent class.  If tokens are available, they will be lent in
                <em class="parameter"><code>quantum</code></em> increments and the leaf class will dequeue up
                to <em class="parameter"><code>cburst</code></em> bytes
              </td></tr><tr><td align="left">leaf</td><td align="left">&gt; <em class="parameter"><code>ceil</code></em></td><td align="left"><em class="parameter"><code>HTB_CANT_SEND</code></em></td><td align="left">
                No packets will be dequeued.  This will cause packet
                delay and will increase latency to meet the desired
                rate.
              </td></tr><tr><td align="left">inner, root</td><td align="left">&lt; <em class="parameter"><code>rate</code></em></td><td align="left"><em class="parameter"><code>HTB_CAN_SEND</code></em></td><td align="left">
                Inner class will lend tokens to children.
              </td></tr><tr><td align="left">inner, root</td><td align="left">&gt; <em class="parameter"><code>rate</code></em>, &lt; <em class="parameter"><code>ceil</code></em></td><td align="left"><em class="parameter"><code>HTB_MAY_BORROW</code></em></td><td align="left">
                Inner class will attempt to borrow tokens/ctokens from
                parent class, lending them to competing children in
                <em class="parameter"><code>quantum</code></em> increments per request.
              </td></tr><tr><td align="left">inner, root</td><td align="left">&gt; <em class="parameter"><code>ceil</code></em></td><td align="left"><em class="parameter"><code>HTB_CANT_SEND</code></em></td><td align="left">
                Inner class will not attempt to borrow from its parent
                and will not lend tokens/ctokens to children classes.
              </td></tr></tbody></table></div><p>
        This diagram identifies the flow of borrowed tokens and the manner in
        which tokens are charged to parent classes.  In order for the
        borrowing model to work, each class must have an accurate count of the
        number of tokens used by itself and all of its children.  For this
        reason, any token used in a child or leaf class is charged to each
        parent class until the root class is reached.
      </p><p>
        Any child class which wishes to borrow a token will request a token
        from its parent class, which if it is also over its <em class="parameter"><code>rate</code></em> will
        request to borrow from its parent class until either a token is
        located or the root class is reached.  So the borrowing of tokens
        flows toward the leaf classes and the charging of the usage of tokens
        flows toward the root class.
      </p><div class="mediaobject"><a id="img-qc-htb-borrow"></a><img src="htb-borrow.png"></div><p>
        Note in this diagram that there are several HTB root classes.
        Each of these root classes can simulate a virtual circuit.
      </p></div><div class="section" xml:lang="en" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="qc-htb-params"></a>7.1.4.&nbsp;HTB class parameters</h4></div></div></div><p>
      </p><div class="variablelist"><a id="vl-qc-htb-params"></a><dl><dt><a id="vl-qc-htb-params-default"></a><span class="term"><em class="parameter"><code>default</code></em></span></dt><dd><p>
              An optional parameter with every HTB <a indepth="true" href="components.html#c-qdisc" title="4.1.&nbsp;qdisc"><code class="constant">qdisc</code></a> object,
              the default <em class="parameter"><code>default</code></em> is 0, which cause any unclassified
              traffic to be dequeued at hardware speed, completely bypassing
              any of the classes attached to the <code class="constant">root</code> qdisc.
            </p></dd><dt><a id="vl-qc-htb-params-rate"></a><span class="term"><em class="parameter"><code>rate</code></em></span></dt><dd><p>
              Used to set the minimum desired speed to which to limit
              transmitted traffic.  This can be considered the equivalent of a
              committed information rate (<span class="acronym">CIR</span>), or the
              guaranteed bandwidth for a given leaf class.
            </p></dd><dt><a id="vl-qc-htb-params-ceil"></a><span class="term"><em class="parameter"><code>ceil</code></em></span></dt><dd><p>
              Used to set the maximum desired speed to which to limit the
              transmitted traffic.  The borrowing model should illustrate how
              this parameter is used.  This can be considered the equivalent
              of “<span class="quote">burstable bandwidth</span>”.
            </p></dd><dt><a id="vl-qc-htb-params-burst"></a><span class="term"><em class="parameter"><code>burst</code></em></span></dt><dd><p>
              This is the size of the <a indepth="true" href="classful-qdiscs.html#vl-qc-htb-params-rate"><em class="parameter"><code>rate</code></em></a> bucket (see
              <a indepth="true" href="overview.html#o-buckets">Tokens and buckets</a>).  HTB will dequeue
              <em class="parameter"><code>burst</code></em> bytes before awaiting the arrival of more
              tokens.
            </p></dd><dt><a id="vl-qc-htb-params-cburst"></a><span class="term"><em class="parameter"><code>cburst</code></em></span></dt><dd><p>
              This is the size of the <a indepth="true" href="classful-qdiscs.html#vl-qc-htb-params-ceil"><em class="parameter"><code>ceil</code></em></a> bucket (see
              <a indepth="true" href="overview.html#o-buckets">Tokens and buckets</a>).  HTB will dequeue
              <em class="parameter"><code>cburst</code></em> bytes before awaiting the arrival of more
              ctokens.
            </p></dd><dt><a id="vl-qc-htb-params-quantum"></a><span class="term"><em class="parameter"><code>quantum</code></em></span></dt><dd><p>
              This is a key parameter used by HTB to control borrowing.
              Normally, the correct <em class="parameter"><code>quantum</code></em> is calculated by
              HTB, not specified by the user.  Tweaking this parameter
              can have tremendous effects on borrowing and shaping under
              contention, because it is used both to split traffic between
              children classes over <a indepth="true" href="classful-qdiscs.html#vl-qc-htb-params-rate"><em class="parameter"><code>rate</code></em></a> (but below
              <a indepth="true" href="classful-qdiscs.html#vl-qc-htb-params-ceil"><em class="parameter"><code>ceil</code></em></a>) and to transmit packets from these same
              classes.
            </p></dd><dt><a id="vl-qc-htb-params-r2q"></a><span class="term"><em class="parameter"><code>r2q</code></em></span></dt><dd><p>
              Also, usually calculated for the user, <em class="parameter"><code>r2q</code></em> is a hint to
              HTB to help determine the optimal <a indepth="true" href="classful-qdiscs.html#vl-qc-htb-params-quantum"><em class="parameter"><code>quantum</code></em></a>
              for a particular class.
            </p></dd><dt><a id="vl-qc-htb-params-mtu"></a><span class="term"><em class="parameter"><code>mtu</code></em></span></dt><dd><p>
            </p></dd><dt><a id="vl-qc-htb-params-prio"></a><span class="term"><em class="parameter"><code>prio</code></em></span></dt><dd><p>
            </p></dd></dl></div><p>
      </p></div><div class="section" xml:lang="en" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="qc-htb-rules"></a>7.1.5.&nbsp;Rules</h4></div></div></div><p>
        Below are some general guidelines to using HTB culled from
        <a xmlns="http://www.w3.org/TR/xhtml1/transitional" class="nonlocal" href="http://docum.org/" target="_top">http://docum.org/</a> and the <a xmlns="http://www.w3.org/TR/xhtml1/transitional" class="nonlocal" href="http://mailman.ds9a.nl/mailman/listinfo/lartc/" target="_top">LARTC
         mailing list</a>.  These rules are
        simply a recommendation for beginners to maximize the benefit of
        HTB until gaining a better understanding of the practical
        application of HTB.
      </p><p>
      </p><div class="itemizedlist"><ul type="disc"><li><p>
            Shaping with HTB occurs only in leaf classes.  See also
            <a indepth="true" href="classful-qdiscs.html#qc-htb-shaping" title="7.1.2.&nbsp;Shaping">Section&nbsp;7.1.2, “Shaping”</a>.
          </p></li><li><p>
            Because HTB does not shape in any class except the leaf
            class, the sum of the <em class="parameter"><code>rate</code></em>s of leaf classes should not
            exceed the <em class="parameter"><code>ceil</code></em> of a parent class.  Ideally, the sum of
            the <em class="parameter"><code>rate</code></em>s of the children classes would match the
            <em class="parameter"><code>rate</code></em> of the parent class, allowing the parent class to
            distribute leftover bandwidth (<em class="parameter"><code>ceil</code></em> - <em class="parameter"><code>rate</code></em>) among
            the children classes.
          </p><p>
            This key concept in employing HTB bears repeating.  Only
            leaf classes actually shape packets; packets are only delayed in
            these leaf classes.  The inner classes (all the way up to the root
            class) exist to define how borrowing/lending occurs (see also
            <a indepth="true" href="classful-qdiscs.html#qc-htb-borrowing" title="7.1.3.&nbsp;Borrowing">Section&nbsp;7.1.3, “Borrowing”</a>).
          </p></li><li><p>
            The <em class="parameter"><code>quantum</code></em> is only  only used when a class is over
            <em class="parameter"><code>rate</code></em> but below <em class="parameter"><code>ceil</code></em>.
          </p></li><li><p>
            The <em class="parameter"><code>quantum</code></em> should be set at MTU or higher.  HTB
            will dequeue a single packet at least per service opportunity even
            if <em class="parameter"><code>quantum</code></em> is too small.  In such a case, it will not be
            able to calculate accurately the real bandwidth consumed
            <sup>[<a id="id2543465" href="#ftn.id2543465">9</a>]</sup>.
          </p></li><li><p>
            Parent classes lend tokens to children in increments of
            <em class="parameter"><code>quantum</code></em>, so for maximum granularity and most
            instantaneously evenly distributed bandwidth, <em class="parameter"><code>quantum</code></em>
            should be as low as possible while still no less than MTU.
          </p></li><li><p>
            A distinction between tokens and ctokens is only meaningful in a
            leaf class, because non-leaf classes only lend tokens to child
            classes.
          </p></li><li><p>
            HTB borrowing could more accurately be described as
            “<span class="quote">using</span>”.
          </p></li></ul></div><p>
      </p></div></div><div class="section" xml:lang="en" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="qc-hfsc"></a>7.2.&nbsp;HFSC, Hierarchical Fair Service Curve</h3></div></div></div><p>
      The HFSC classful qdisc balances delay-sensitive traffic against
      throughput sensitive traffic.  In a congested or backlogged state, the
      HFSC queuing discipline interleaves the delay-sensitive traffic when
      required according service curve definitions.  Read about the Linux
      implementation in German, <a xmlns="http://www.w3.org/TR/xhtml1/transitional" class="nonlocal" href="http://klaus.geekserver.net/hfsc/hfsc.html" target="_top">HFSC
           Scheduling mit Linux</a> or read a
      translation into English, <a xmlns="http://www.w3.org/TR/xhtml1/transitional" class="nonlocal" href="http://linux-ip.net/tc/hfsc.en/" target="_top">HFSC Scheduling
          with Linux</a>.  The original
      research article, <a xmlns="http://www.w3.org/TR/xhtml1/transitional" class="nonlocal" href="http://acm.org/sigcomm/sigcomm97/program.html#ab011" target="_top">A
         Hierarchical Fair Service Curve Algorithm For Link-Sharing, Real-Time
         and Priority Services</a>, also remains available.
    </p><p>
      This section will be completed at a later date.
    </p></div><div class="section" xml:lang="en" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="qc-prio"></a>7.3.&nbsp;PRIO, priority scheduler</h3></div></div></div><p>
      The PRIO classful qdisc works on a very simple precept.  When it
      is ready to dequeue a packet, the first class is checked for a packet.
      If there's a packet, it gets dequeued.  If there's no packet, then the
      next class is checked, until the queuing mechanism has no more classes
      to check.
    </p><p>
      This section will be completed at a later date.
    </p></div><div class="section" xml:lang="en" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="qc-cbq"></a>7.4.&nbsp;CBQ, Class Based Queuing</h3></div></div></div><p>
      CBQ is the classic implementation (also called venerable) of a traffic
      control system.  This section will be completed at a later date.
    </p><p>
    </p></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a id="ftn.id2543465" href="#id2543465">9</a>] </sup>
                HTB will report bandwidth usage in this scenario
                incorrectly.  It will calculate the bandwidth used by
                <em class="parameter"><code>quantum</code></em> instead of the real dequeued packet size.
                This can skew results quickly.
              </p></div></div></div><div class="navfooter"><hr><table summary="Navigation footer" width="100%"><tbody><tr><td width="40%" align="left"><a indepth="true" accesskey="p" href="classless-qdiscs.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a indepth="true" accesskey="n" href="rules.html">Next</a></td></tr><tr><td valign="top" width="40%" align="left">6.&nbsp;Classless Queuing Disciplines (<code class="constant">qdisc</code>s)&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="http://linux-ip.net/articles/Traffic-Control-HOWTO/index.html">Home</a></td><td valign="top" width="40%" align="right">&nbsp;8.&nbsp;Rules, Guidelines and Approaches</td></tr></tbody></table></div>


</body></html>
