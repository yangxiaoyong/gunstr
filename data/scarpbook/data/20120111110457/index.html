<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">


<meta name="robots" content="index,nofollow">

<title>PostfixCompleteVirtualMailSystemHowto - Community Ubuntu Documentation</title>










<!-- css only for MS IE6/IE7 browsers -->
<!--[if lt IE 8]>
   <link rel="stylesheet" type="text/css" charset="utf-8" media="all" href="/moin_static192/ubuntunew/css/msie.css">
<![endif]-->





<link rel="Start" href="https://help.ubuntu.com/community/UserDocumentation">
<link rel="Alternate" title="Wiki Markup" href="https://help.ubuntu.com/community/PostfixCompleteVirtualMailSystemHowto?action=raw">
<link rel="Alternate" media="print" title="Print View" href="https://help.ubuntu.com/community/PostfixCompleteVirtualMailSystemHowto?action=print">
<link rel="Appendix" title="CompleteSetupOverview.png" href="https://help.ubuntu.com/community/PostfixCompleteVirtualMailSystemHowto?action=AttachFile&amp;do=view&amp;target=CompleteSetupOverview.png">
<link rel="Appendix" title="IconHint.png" href="https://help.ubuntu.com/community/PostfixCompleteVirtualMailSystemHowto?action=AttachFile&amp;do=view&amp;target=IconHint.png">
<link rel="Appendix" title="IconWarning.png" href="https://help.ubuntu.com/community/PostfixCompleteVirtualMailSystemHowto?action=AttachFile&amp;do=view&amp;target=IconWarning.png">
<link rel="Search" href="https://help.ubuntu.com/community/FindPage">
<link rel="Index" href="https://help.ubuntu.com/community/TitleIndex">
<link rel="Glossary" href="https://help.ubuntu.com/community/WordIndex">
<link rel="Help" href="https://help.ubuntu.com/community/HelpOnFormatting">

<link rel="stylesheet" type="text/css" href="index.css" media="all">
</head>
<body dir="ltr" lang="en">

<div id="round" class="roundme">
<img id="topcap" alt="" src="cap-top.png">
<div id="layout" class="container clear-block">
<div id="header">
<div id="logo-floater">
<h1><a href="http://help.ubuntu.com/" title="Ubuntu Documentation"><img alt="Ubuntu" id="logo" src="logo.png"></a></h1>
</div>



<form action="https://help.ubuntu.com/search.html" id="cse-search-box">  <div>    <input name="cof" value="FORID:9" type="hidden">    <input name="cx" value="004599128559784038176:vj_p0xo-nng" type="hidden">    <input name="ie" value="UTF-8" type="hidden">    <input value="" name="q" size="27" type="text">    <input name="sa" value="Search" type="submit">  </div></form>

<div id="sitename"><a href="https://help.ubuntu.com/community"><img src="help-faq.png"><span>Community Documentation</span></a></div>
</div> <!--header-->
<ul id="loginbar"><li><a href="https://help.ubuntu.com/community/PostfixCompleteVirtualMailSystemHowto?action=login" id="login" rel="nofollow">Login to Edit</a></li></ul>


<!--1-->
<div id="page" dir="ltr" lang="en">

<!--2-->

<div id="breadcrumbs">
<a href="https://help.ubuntu.com/">Ubuntu Documentation</a> &gt; <a href="https://help.ubuntu.com/community">Community Documentation</a> &gt; <a class="backlink" href="https://help.ubuntu.com/community/PostfixCompleteVirtualMailSystemHowto?action=fullsearch&amp;context=180&amp;value=linkto%3A%22PostfixCompleteVirtualMailSystemHowto%22" rel="nofollow" title="Click to do a full-text search for this title">PostfixCompleteVirtualMailSystemHowto</a>
</div>


<ul id="pagelocation">
<li><a class="backlink" href="https://help.ubuntu.com/community/PostfixCompleteVirtualMailSystemHowto?action=fullsearch&amp;context=180&amp;value=linkto%3A%22PostfixCompleteVirtualMailSystemHowto%22" rel="nofollow" title="Click to do a full-text search for this title">PostfixCompleteVirtualMailSystemHowto</a></li>
</ul>

<!--3--><div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><p class="line867"></p><div dir="ltr" id="Tag.2BAC8-NeedsExpansion.content" lang="en"><span class="anchor" id="Tag.2BAC8-NeedsExpansion.top"></span>
<span class="anchor" id="Tag.2BAC8-NeedsExpansion.line-1"></span><div><table style="border: 2px solid black; background: none repeat scroll 0% 0% rgb(245, 230, 39); width: 80%; margin-left: 10%; margin-right: 10%; text-align: center;"><tbody><tr>  <td><p class="line862"> <strong>Needs Expansion:</strong> This article is incomplete, and needs to be expanded. <a href="https://help.ubuntu.com/community/Tag#NeedsExpansion">More info...</a> </p></td>
</tr>
</tbody></table></div><span class="anchor" id="Tag.2BAC8-NeedsExpansion.line-2"></span><span class="anchor" id="Tag.2BAC8-NeedsExpansion.bottom"></span></div> <span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line867"><span class="anchor" id="line-4"></span></p><p class="line867"><span class="anchor" id="line-5"></span><span class="anchor" id="line-6"></span></p><div><table style="float: right; font-size: 0.9em; width: 40%; background: none repeat scroll 0% 0% rgb(241, 241, 237); margin: 0pt 0pt 1em 1em;"><tbody><tr>  <td style="padding: 0.5em;"><p class="line891"></p><div class="table-of-contents"><p class="table-of-contents-heading">Contents</p><ol><li>
<a href="#Abstract">Abstract</a></li><li>
<a href="#System_Overview">System Overview</a><ol><li>
<a href="#What_You_Get">What You Get</a></li><li>
<a href="#Packages_Required">Packages Required</a></li><li>
<a href="#The_Big_Picture">The Big Picture</a></li></ol></li><li>
<a href="#How_Postfix_Mappings_Work.3F">How Postfix Mappings Work?</a></li><li>
<a href="#How_Postfix_Virtual_Domains_Work.3F">How Postfix Virtual Domains Work?</a></li><li>
<a href="#Installing_a_Ubuntu_Server_System">Installing a Ubuntu Server System</a></li><li>
<a href="#DNS_Setup">DNS Setup</a></li><li>
<a href="#Package_Installation_and_Configuration">Package Installation and Configuration</a></li><li>
<a href="#Postfix_Base_Server_Installation">Postfix Base Server Installation</a><ol><li>
<a href="#Installing_Postfix">Installing Postfix</a></li><li>
<a href="#Installing__MySQL_map_support_for_Postfix">Installing  MySQL map support for Postfix</a></li></ol></li><li>
<a href="#Installing_Packages_for_Client_Access_and_Authentication">Installing Packages for Client Access and Authentication</a></li><li>
<a href="#Installing_package_for_SMTP_authentication">Installing package for SMTP authentication</a></li><li>
<a href="#Setting_MySQL_Backend">Setting MySQL Backend</a><ol><li>
<a href="#Setting_MySQL_root_Password">Setting MySQL root Password</a></li><li>
<a href="#Setting_MySQL_Database_for_Impatient_Users">Setting MySQL Database for Impatient Users</a></li><li>
<a href="#Step_by_Step_Database_Setup">Step by Step Database Setup</a><ol><li>
<a href="#Setting_up_Database.2C_Users.2C_and_Privileges">Setting up Database, Users, and Privileges</a></li><li>
<a href="#Create_the_Table_Admin">Create the Table Admin</a></li><li>
<a href="#Create_the_Alias_table">Create the Alias table</a></li><li>
<a href="#Create_the_Domain_table">Create the Domain table</a></li><li>
<a href="#Create_the_Domain_Admin_Table">Create the Domain Admin Table</a></li><li>
<a href="#Create_the_Mailbox_Table">Create the Mailbox Table</a></li><li>
<a href="#Create_the_Log_Table">Create the Log Table</a></li><li>
<a href="#Create_the_Vacation_Table">Create the Vacation Table</a></li><li>
<a href="#Finish">Finish</a></li></ol></li></ol></li><li>
<a href="#Setting_Postfix_MySQL_Maps">Setting Postfix MySQL Maps</a><ol><li>
<a href="#Creating_Virtual_Alias_Maps">Creating Virtual Alias Maps</a></li><li>
<a href="#Virtual_Domain_Maps">Virtual Domain Maps</a></li><li>
<a href="#Virtual_Mailbox_Maps">Virtual Mailbox Maps</a></li><li>
<a href="#Virtual_Mailbox_Quota_Maps">Virtual Mailbox Quota Maps</a></li><li>
<a href="#Relay_Domain_Maps">Relay Domain Maps</a></li><li>
<a href="#Create_a_vmail_user">Create a vmail user</a></li></ol></li><li>
<a href="#Configuring_Postfix_with_MySQL_maps">Configuring Postfix with MySQL maps</a></li><li>
<a href="#Setting_up_Postfix">Setting up Postfix</a></li><li>
<a href="#Enhanced_Mail_Services">Enhanced Mail Services</a><ol><li>
<a href="#Postfixadmin">Postfixadmin</a></li><li>
<a href="#Courier-IMAP_and_Authentication_Services">Courier-IMAP and Authentication Services</a></li><li>
<a href="#SMTP_Authentication">SMTP Authentication</a></li><li>
<a href="#Web_Access">Web Access</a></li><li>
<a href="#Refining_the_Setup">Refining the Setup</a></li></ol></li><li>
<a href="#Anti-Spam_Configuration">Anti-Spam Configuration</a><ol><li>
<a href="#Installing_Amavisd_and_Spamassassin">Installing Amavisd and Spamassassin</a></li><li>
<a href="#Quarantine_and_Spam_Management">Quarantine and Spam Management</a></li><li>
<a href="#Auto_and_Per-Recipient_White.2BAC8-Black_Lists">Auto and Per-Recipient White/Black Lists</a></li><li>
<a href="#Amavis.2BAC8-Spamassassin_UI">Amavis/Spamassassin UI</a></li><li>
<a href="#GreyListing">GreyListing</a></li><li>
<a href="#Distributed_and_Collaborative_Networks">Distributed and Collaborative Networks</a></li></ol></li><li>
<a href="#Anti-Virus_Configuration">Anti-Virus Configuration</a><ol><li>
<a href="#Configuring_for_ClamAV">Configuring for ClamAV</a></li></ol></li><li>
<a href="#Log_Analyzer">Log Analyzer</a><ol><li>
<a href="#Install_and_Configure_AWStats">Install and Configure AWStats</a></li></ol></li><li>
<a href="#Wrapping_it_Up">Wrapping it Up</a></li><li>
<a href="#Final_Changes_and_Troubleshooting">Final Changes and Troubleshooting</a></li><li>
<a href="#Other_links">Other links</a></li></ol></div></td>
</tr>
</tbody></table></div><span class="anchor" id="line-7"></span><span class="anchor" id="line-8"></span><p class="line867">
</p><h1 id="Abstract">Abstract</h1>
<span class="anchor" id="line-9"></span><span class="anchor" id="line-10"></span><p class="line874">There are many howtos in the Internet about setting up mail servers and various people has various choice of MTAs. Some like, Qmail, while some like Postfix or Exim. I have been using Qmail for a long time and it is an excellent MTA. The way the Qmail is licensed and distributed that there are no binary packages so that users can easily setup with their favorite distribution, and installing basic Qmail setup even is not that difficult but users need applied various patches and tweaks etc to get a complete  setup done. With all these issues Qmail is the preferred choice of many geeks, since it won't give you head ache once up and running. The drawback is that this system is difficult to upgrade since users need to compile the source code and install. <span class="anchor" id="line-11"></span><span class="anchor" id="line-12"></span></p><p class="line862">The decision behind this guide is to use Postfix,an equally secure and fast MTA like Qmail, it is easy to configure and setup a <a href="https://help.ubuntu.com/community/PostfixBasicSetupHowto">Basic System</a> in any Linux distribution. Postfix has many add-ons and support Maildir format, PostgreSQL and MySQL backend for  storing and managing virtual domains very  easily. This setup will be a complete virtual mail domain systems , with anti-virus and spam filtering for ISPs , hosting companies, and individual corporations who wish to use Ubuntu Linux as there preferred server platform. <span class="anchor" id="line-13"></span><span class="anchor" id="line-14"></span></p><p class="line867">
</p><h1 id="System_Overview">System Overview</h1>
<span class="anchor" id="line-15"></span><span class="anchor" id="line-16"></span><p class="line874">It is important to know how our system works before going to install. A virtual mail system needs to be able to handle email for numerous domains with multiple users over a variety of interfaces. When you handle multiple domains within the same mail system it presents you some management issues. We have to answer these issues using  our technology. Assume ,for example you may have following questions to answer. <span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span></p><ul><li>What will you do if you have two users which require same username for different domains? <span class="anchor" id="line-19"></span><span class="anchor" id="line-20"></span></li><li class="gap">If you are providing imap access and smtp-auth, how do combine the various authentication daemons into a single system? <span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span></li><li class="gap">How do you provide security for the numerous components that comprise the system? <span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span></li><li class="gap">What we can do, if users are asking their own spam filtering policies. <span class="anchor" id="line-25"></span><span class="anchor" id="line-26"></span></li><li class="gap">Individual domain administrators are asking a web-based interface to manage their mail domains <span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span></li><li class="gap">How do you setup a web-based management system for Postfix? <span class="anchor" id="line-29"></span><span class="anchor" id="line-30"></span></li><li class="gap">Each user needs a web-base interface to change his mail account's password <span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span></li><li class="gap">How you are going backup user account database and disaster recovery?. <span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span></li><li class="gap">Utilizing ssl for transport layer security <span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span></li><li class="gap">Handle mailing lists for any domain <span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span></li></ul><p class="line867"><strong>How do you manage all these issues together?</strong> <span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span></p><p class="line874">Don't panic, I will answer all these questions one by one. Be happy and continue to read this howto. <span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span></p><p class="line867">
</p><h2 id="What_You_Get">What You Get</h2>
<span class="anchor" id="line-43"></span><span class="anchor" id="line-44"></span><ul><li>Web based system administration <span class="anchor" id="line-45"></span></li><li>Unlimited number of domains <span class="anchor" id="line-46"></span></li><li>Virtual mail users without the need for shell accounts <span class="anchor" id="line-47"></span></li><li>Domain specific user names <span class="anchor" id="line-48"></span></li><li>Mailbox quotas <span class="anchor" id="line-49"></span></li><li>Web access to email accounts <span class="anchor" id="line-50"></span></li><li>Web base interface to change user passwords <span class="anchor" id="line-51"></span></li><li>IMAP and POP3 support <span class="anchor" id="line-52"></span></li><li>Auto responders <span class="anchor" id="line-53"></span></li><li>SMTP Authentication for secure relaying <span class="anchor" id="line-54"></span></li><li>SSL for transport layer security <span class="anchor" id="line-55"></span></li><li>Strong SPAM filtering <span class="anchor" id="line-56"></span></li><li>Anti-Virus filtering <span class="anchor" id="line-57"></span></li><li>Log Analysis <span class="anchor" id="line-58"></span><span class="anchor" id="line-59"></span></li></ul><p class="line867">
</p><h2 id="Packages_Required">Packages Required</h2>
<span class="anchor" id="line-60"></span><span class="anchor" id="line-61"></span><p class="line874">The following packages are needed to implement our system and most of these packages are in APT repositories. In our installation section you will learn how to install and configure each. <span class="anchor" id="line-62"></span><span class="anchor" id="line-63"></span></p><ul><li><p class="line891"><a class="http" href="http://www.webmin.com/">Webmin</a> <span class="anchor" id="line-64"></span></p></li><li><p class="line891"><a class="http" href="http://www.postfix.org/">Postfix</a> <span class="anchor" id="line-65"></span></p></li><li><p class="line891"><a class="http" href="http://www.mysql.com/">MySQL</a> <span class="anchor" id="line-66"></span></p></li><li><p class="line891"><a class="http" href="http://www.apache.org/">Apache</a> <span class="anchor" id="line-67"></span></p></li><li><p class="line891"><a class="http" href="http://www.php.net/">PHP</a> <span class="anchor" id="line-68"></span></p></li><li><p class="line891"><a class="http" href="http://high5.net/postfixadmin/">Postfixadmin</a> <span class="anchor" id="line-69"></span></p></li><li><p class="line891"><a class="http" href="http://www.courier-mta.org/imap/">Courier-IMAP</a> <span class="anchor" id="line-70"></span></p></li><li><p class="line891"><a class="http" href="http://www.courier-mta.org/?pop3d.html">Courier-POP3</a> <span class="anchor" id="line-71"></span></p></li><li><p class="line891"><a class="http" href="http://www.courier-mta.org/authlib/">Courier-authlib</a> <span class="anchor" id="line-72"></span></p></li><li><p class="line891"><a class="http" href="http://asg.web.cmu.edu/sasl/">Cyrus-SASL</a> <span class="anchor" id="line-73"></span></p></li><li><p class="line891"><a class="http" href="http://www.gnu.org/software/ispell/ispell.html">Ispell</a> <span class="anchor" id="line-74"></span></p></li><li><p class="line891"><a class="http" href="http://www.squirrelmail.org/">Squirrelmail</a> <span class="anchor" id="line-75"></span></p></li><li><p class="line891"><a class="http" href="http://awstats.sourceforge.net/">Awstats</a> <span class="anchor" id="line-76"></span></p></li><li><p class="line891"><a class="http" href="http://www.ijs.si/software/amavisd/">Amavisd-new</a> <span class="anchor" id="line-77"></span></p></li><li><p class="line891"><a class="http" href="http://spamassassin.apache.org/">Spamassassin</a> <span class="anchor" id="line-78"></span></p></li><li><p class="line891"><a class="http" href="http://www.mailzu.net/">MailZu</a> <span class="anchor" id="line-79"></span></p></li><li><p class="line891"><a class="http" href="http://razor.sourceforge.net/">Razor</a> <span class="anchor" id="line-80"></span></p></li><li><p class="line891"><a class="http" href="http://www.rhyolite.com/anti-spam/dcc/">DCC</a> <span class="anchor" id="line-81"></span></p></li><li><p class="line891"><a class="http" href="http://pyzor.sourceforge.net/">Pyzor</a> <span class="anchor" id="line-82"></span></p></li><li><p class="line891"><a class="http" href="http://sqlgrey.sourceforge.net/">SQLgrey</a> <span class="anchor" id="line-83"></span></p></li><li><p class="line891"><a class="http" href="http://www.vanheusden.com/sgwi/">Sgwi</a> <span class="anchor" id="line-84"></span></p></li><li><p class="line891"><a class="http" href="http://www.clamav.net/">Clamav</a> <span class="anchor" id="line-85"></span><span class="anchor" id="line-86"></span></p></li></ul><p class="line867">
</p><h2 id="The_Big_Picture">The Big Picture</h2>
<span class="anchor" id="line-87"></span><span class="anchor" id="line-88"></span><p class="line874">The following figure shows the big picture of our setup. If you look at it carefully the figure itself is self explanatory. <span class="anchor" id="line-89"></span><span class="anchor" id="line-90"></span></p><p class="line867"><img alt="CompleteSetupOverview.png" class="attachment" src="postfixcompletevirtualmailsystemhowto" title="CompleteSetupOverview.png"> <span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span></p><p class="line874">In our setup: <span class="anchor" id="line-93"></span><span class="anchor" id="line-94"></span></p><ul><li><p class="line891"><strong>Postfix</strong> Mail Transfer Agent receives emails via the SMTP protocol and delivers them to different places on your hard disk. <span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span></p></li><li class="gap"><p class="line891"><strong>MySQL</strong> database server stores the information to control the behavior of postfix. It knows about users, domains, email forwarding and passwords. <span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span></p></li><li class="gap"><p class="line891"><strong>Courier</strong> is a standalone mail server just like Postfix but we just use its POP3/IMAP server component to let users access the mailboxes. <span class="anchor" id="line-99"></span><span class="anchor" id="line-100"></span></p></li><li class="gap"><p class="line891"><strong>SASL</strong>, the Cyrus library  is using to authenticate  your users who are dialed in at another ISP while they are on the road they get an IP address outside of your network. Your mail server however only trusts local IP addresses. The SASL  ,<strong>Simple Authentication and Security Layer</strong>, adds authentication to SMTP and makes your mail server trust them. <span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span><span class="anchor" id="line-103"></span></p></li></ul><p class="line867">
</p><h1 id="How_Postfix_Mappings_Work.3F">How Postfix Mappings Work?</h1>
<span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span><p class="line874">It is very important to understand how Postfix mapping works. Heart of our system is Postfix mapping. Let's discuss it here. Don't skip this section. <span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span></p><p class="line862">The generic literal meaning of mapping is assign one value to another. What we have to map in Postfix is email user accounts or email address. One example is <strong><tt>/etc/aliases</tt></strong>, the  local aliases or local system users mapping file used by Postfix. The syntax of this file is: <span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span></p><p class="line867"><span class="anchor" id="line-110"></span><span class="anchor" id="line-111"></span></p><pre><span class="anchor" id="line-1"></span>postmaster: root</pre><span class="anchor" id="line-112"></span><span class="anchor" id="line-113"></span><p class="line862">This makes all the mails which are coming to <strong><tt>postmaster@yourdomain.tld</tt></strong> are redirected to <strong><tt>root@yourdomain.tld</tt></strong>. We can divide the above syntax to Left Hand Side <strong>LHS</strong> and Right Hand Side <strong>RHS</strong>. This RHS and LHS are common abbreviations which we usually used in mappings. The following table will make this idea even more clear. <span class="anchor" id="line-114"></span><span class="anchor" id="line-115"></span></p><div><table><tbody><tr>  <td><p class="line891"><strong>LHS</strong></p></td>
  <td><p class="line891"><strong>RHS</strong></p></td>
</tr>
<tr>  <td><span class="anchor" id="line-116"></span><p class="line862">postmaster:</p></td>
  <td><p class="line862">root</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-117"></span><span class="anchor" id="line-118"></span><div><table><tbody><tr>  <td><p class="line862"> <img alt="IconHint.png" class="attachment" src="postfixcompletevirtualmailsystemhowto_001.dat" title="IconHint.png"> </p></td>
  <td><p class="line862"> Usually we do not use colon(:) in LHS for Postfix and this has been done for backward compatibility with historical reasons. The local alias file is a special file that is compiled with <strong>newaliases</strong> command but not with usual Postfix mapping command <strong>postmap</strong></p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-119"></span><span class="anchor" id="line-120"></span><p class="line862">With a basic default Postfix installation we use text file for mappings. We write the mappings into this file and then convert it into a <strong>hash</strong> file using <strong>postmap</strong> command so Postfix can look up items quickly. For example, assume that we need to map our virtual mailboxes in a file called <strong><tt>/etc/Postfix/virtual_mailboxes</tt></strong>. The syntax of this file look like: <span class="anchor" id="line-121"></span><span class="anchor" id="line-122"></span></p><p class="line867"><span class="anchor" id="line-123"></span><span class="anchor" id="line-124"></span><span class="anchor" id="line-125"></span></p><pre><span class="anchor" id="line-1-1"></span>info@domain1.com sigiri
<span class="anchor" id="line-2"></span>info@domain2.com kala</pre><span class="anchor" id="line-126"></span><span class="anchor" id="line-127"></span><p class="line862">You may have noticed that we don't have colon(:) in the <strong>LHS</strong> of the mappings file <span class="anchor" id="line-128"></span><span class="anchor" id="line-129"></span></p><p class="line874">Then you need to run: <span class="anchor" id="line-130"></span><span class="anchor" id="line-131"></span></p><p class="line867"><span class="anchor" id="line-132"></span><span class="anchor" id="line-133"></span></p><pre><span class="anchor" id="line-1-2"></span>postmap /etc/postfix/virtual_mailboxes</pre><span class="anchor" id="line-134"></span><span class="anchor" id="line-135"></span><p class="line874">You can access this mappings in the Postfix configuration file by including the following line: <span class="anchor" id="line-136"></span><span class="anchor" id="line-137"></span></p><p class="line867"><span class="anchor" id="line-138"></span><span class="anchor" id="line-139"></span></p><pre><span class="anchor" id="line-1-3"></span>virtual_mailbox_maps = hash:/etc/postfix/virtual_mailboxes</pre><span class="anchor" id="line-140"></span><span class="anchor" id="line-141"></span><p class="line874">In our setup, we will replace this text mapping files with MySQL tables. Our intention is to make data handling lot more flexible, robust, and scalable. Since database tables can and usually contain more than just two columns you will need to tell Postfix which database column is meant to be the LHS and which is the RHS. This is accomplished by creating a configuration file which will look something like this: <span class="anchor" id="line-142"></span><span class="anchor" id="line-143"></span></p><p class="line867"><span class="anchor" id="line-144"></span><span class="anchor" id="line-145"></span><span class="anchor" id="line-146"></span><span class="anchor" id="line-147"></span><span class="anchor" id="line-148"></span><span class="anchor" id="line-149"></span><span class="anchor" id="line-150"></span><span class="anchor" id="line-151"></span><span class="anchor" id="line-152"></span></p><pre><span class="anchor" id="line-1-4"></span>user = postfix
<span class="anchor" id="line-2-1"></span>password = YJiNLQtubgnOE
<span class="anchor" id="line-3"></span>hosts = 127.0.0.1
<span class="anchor" id="line-4"></span>dbname = postfix
<span class="anchor" id="line-5"></span>table = mailbox
<span class="anchor" id="line-6"></span>select_field = maildir
<span class="anchor" id="line-7"></span>where_field = username
<span class="anchor" id="line-8"></span>#additional_conditions = and active = '1'</pre><span class="anchor" id="line-153"></span><span class="anchor" id="line-154"></span><p class="line862">For the purposes of this discussion, lets assume this is saved in a file called <strong><tt>/etc/postfix/mysql_virtual_mailbox_maps.cf</tt></strong>. You would then be able to use this mapping in postfix using the following entry in <strong><tt>main.cf</tt></strong> file. <span class="anchor" id="line-155"></span><span class="anchor" id="line-156"></span></p><p class="line867"><span class="anchor" id="line-157"></span><span class="anchor" id="line-158"></span></p><pre><span class="anchor" id="line-1-5"></span>virtual_mailbox_maps = mysql:/etc/postfix/mysql_virtual_mailbox_maps.cf</pre><span class="anchor" id="line-159"></span><span class="anchor" id="line-160"></span><p class="line862">The fields in this configuration file are the <strong>user</strong> that needs to connect to the MySQL database, <strong>password</strong> of that MySQL user, <strong>dbname</strong>, the name of the MySQL database, <strong>table</strong> ,the name of the table in MySQL database and <strong>hosts</strong>, the name of the server that MySQL runs on. <span class="anchor" id="line-161"></span><span class="anchor" id="line-162"></span></p><p class="line862">Postfix uses the this configuration file as a guide on how to use the database table as a mapping similar to the mapping file with two fields described above. The LHS of the mapping is defined as <strong><tt>where_field</tt></strong> and the RHS is defined as <strong><tt>select_field</tt></strong>. In this example we will map the <strong><tt>maildir</tt></strong> column to the <strong><tt>username</tt></strong> column. Using the configuation, Postfix constructs a SQL query something like <em>select maildir from postfix.mailbox where username='johndoe' </em> to lookup the maildir for a given username. The following table breaks this distiction out: <span class="anchor" id="line-163"></span><span class="anchor" id="line-164"></span></p><div><table><tbody><tr>  <td><p class="line891"><strong>LHS</strong></p></td>
  <td><p class="line891"><strong>RHS</strong></p></td>
</tr>
<tr>  <td><span class="anchor" id="line-165"></span><p class="line862">where_field</p></td>
  <td><p class="line862">select_field</p></td>
</tr>
<tr>  <td><span class="anchor" id="line-166"></span><p class="line862">username</p></td>
  <td><p class="line862">maildir</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-167"></span><span class="anchor" id="line-168"></span><p class="line867">
</p><h1 id="How_Postfix_Virtual_Domains_Work.3F">How Postfix Virtual Domains Work?</h1>
<span class="anchor" id="line-169"></span><span class="anchor" id="line-170"></span><p class="line874">Understanding how virtual domains work is very important to understand how our virtual mail setup works. <span class="anchor" id="line-171"></span><span class="anchor" id="line-172"></span></p><p class="line874">There are two types of domains in Postfix. <span class="anchor" id="line-173"></span><span class="anchor" id="line-174"></span></p><ul><li><p class="line891"><strong>Local domains:</strong> All domains which are listed as <strong>mydestination</strong> are treated as <strong>local domains</strong> by Postfix. Emails for local domains are delivered to system users which are listed in <strong><tt>/etc/passwd</tt></strong> file and these mails are spooled in <strong><tt>/var/mail</tt></strong> directory. <span class="anchor" id="line-175"></span><span class="anchor" id="line-176"></span></p></li><li class="gap"><p class="line891"><strong>Virtual domains:</strong> In addition to the local domains Postfix can deliver mails for <strong>virtual domains</strong>. Unlike local domains, Postfix will let us handle virtual domains in a very flexible manner. The good thing with virtual domains is that we do not need system account in <strong><tt>/etc/passwd</tt></strong> for each and every mail account. This provides us a way to handle thousands of mail accounts very easily in our mail server system. The mapping which we discussed above is used to handle mail account information.  You can use MySQL, PostgreSQL , or LDAP for the user account management. In our setup we use MySQL backend to manage user accounts of virtual domains. <span class="anchor" id="line-177"></span><span class="anchor" id="line-178"></span>Postfix handles virtual domains as two different categories and you need to understand how this works. <span class="anchor" id="line-179"></span><span class="anchor" id="line-180"></span><span class="anchor" id="line-181"></span></p><ul><li><p class="line891"><strong>Virtual alias domains:</strong> These domains are used to forward or alias mails from one email address to another email address. Such domains can be used receive mailboxes and store on your hard disk. You do not necessarily need to use <strong>virtual alias domains</strong> in your setup. Instead we can user <strong>virtual_alias_maps </strong> even if the domains are not listed as <strong>virtual alias domains</strong>. The <strong>virtual_alias_maps</strong> is a general-purpose redirection mapping that works for everything that passes your system including local domains. <span class="anchor" id="line-182"></span><span class="anchor" id="line-183"></span></p></li><li class="gap"><p class="line891"><strong>Virtual mailbox domains:</strong> Postfix uses these domains to receive mails for users under the domains and store them in the mailboxes on the hard disk. This is parameter which will simply tell Postfix to receive the mails on behalf of the domain and store them in each user's mailbox. The <strong>virtual_mailbox_maps</strong> mapping is used by Postfix to determine the location of the mailbox on your hard disk. Please remember that you can still use the <strong>virtual_alias_maps</strong> mapping to forward email to other mailboxes or external email addresses so not every user on that domain must actually have a mailbox but can also just have the email forwarded somewhere else. <span class="anchor" id="line-184"></span><span class="anchor" id="line-185"></span></p></li></ul></li></ul><div><table><tbody><tr>  <td><p class="line862"> <img alt="IconHint.png" class="attachment" src="postfixcompletevirtualmailsystemhowto_001.dat" title="IconHint.png"> </p></td>
  <td><p class="line862"> It is important to understand that a domain is either a <strong>virtual alias domain</strong> or a <strong>virtual mailbox domain</strong> or a <strong>local domain</strong>. If you make a domain a <strong>virtual alias domain</strong> you will not be able to receive email for that domain on your server. On the contrary you can use the <strong>virtual_alias_maps</strong> to forward/alias email for both types of domain. So the virtual mailbox domains are generally the more flexible to use.</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-186"></span><span class="anchor" id="line-187"></span><div><table><tbody><tr>  <td><p class="line862"> <img alt="IconWarning.png" class="attachment" src="postfixcompletevirtualmailsystemhowto_002.dat" title="IconWarning.png"> </p></td>
  <td><p class="line862"> A domain can either be virtual or local and you can not use one domain in the both of these roles. Please never both. So if you decide you want your default domain be a virtual domain then remove it from the <strong>mydestination</strong> definition. Just leave it blank or set it to <strong>mydestination=localhost</strong>. Email addresses like root@localhost would then be delivered to the local <strong>root</strong> user.</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-188"></span><span class="anchor" id="line-189"></span><span class="anchor" id="line-190"></span><p class="line867">
</p><h1 id="Installing_a_Ubuntu_Server_System">Installing a Ubuntu Server System</h1>
<span class="anchor" id="line-191"></span><span class="anchor" id="line-192"></span><p class="line862">In this howto I assume that you already know how to setup a Ubuntu server system. I would suggest you to do a Ubuntu server installation without a GUI. If you want to know more about installation look <a class="https" href="https://wiki.ubuntu.com/Installation">here</a> <span class="anchor" id="line-193"></span><span class="anchor" id="line-194"></span></p><p class="line867">
</p><h1 id="DNS_Setup">DNS Setup</h1>
<span class="anchor" id="line-195"></span><span class="anchor" id="line-196"></span><p class="line862">This how to assumes that you already have at least one valid registered domain with an MX record setup for that domain. Setting up a BIND DNS server can be learned <a class="https" href="https://wiki.ubuntu.com/BIND9ServerHowto">here</a> <span class="anchor" id="line-197"></span><span class="anchor" id="line-198"></span></p><p class="line867">
</p><h1 id="Package_Installation_and_Configuration">Package Installation and Configuration</h1>
<span class="anchor" id="line-199"></span><span class="anchor" id="line-200"></span><p class="line862">You will to have install and configure all packages which I have mentioned in the <strong>"Package  Required"</strong> section. Let's deal with one by one. <span class="anchor" id="line-201"></span><span class="anchor" id="line-202"></span></p><p class="line867">
</p><h1 id="Postfix_Base_Server_Installation">Postfix Base Server Installation</h1>
<span class="anchor" id="line-203"></span><span class="anchor" id="line-204"></span><p class="line874">Here we install Postfix and other packages which Postfix  requires connect with a MySQL backend. <span class="anchor" id="line-205"></span><span class="anchor" id="line-206"></span></p><p class="line867">
</p><h2 id="Installing_Postfix">Installing Postfix</h2>
<span class="anchor" id="line-207"></span><span class="anchor" id="line-208"></span><p class="line862">When you install Postfix I would suggest to select <strong>"Internet Site"</strong> option. <span class="anchor" id="line-209"></span><span class="anchor" id="line-210"></span></p><p class="line862">To install Postfix, you need to install the <tt>postfix</tt> package. For Postfix documentation, you need the  <tt>postfix-doc</tt> package. <span class="anchor" id="line-211"></span><span class="anchor" id="line-212"></span></p><p class="line867">
</p><h2 id="Installing__MySQL_map_support_for_Postfix">Installing  MySQL map support for Postfix</h2>
<span class="anchor" id="line-213"></span><span class="anchor" id="line-214"></span><p class="line862">We need to add MySQL mapping support for Postfix. Hope that you have already read <strong>How Postfix Mappings Work?</strong> section in this how to. <span class="anchor" id="line-215"></span><span class="anchor" id="line-216"></span></p><p class="line862">To install postfix-mysql, install the <tt>postfix-mysql</tt> package. <span class="anchor" id="line-217"></span><span class="anchor" id="line-218"></span></p><p class="line862">To install MySQL client program, install the  <tt>mysql-client</tt> package. <span class="anchor" id="line-219"></span><span class="anchor" id="line-220"></span></p><p class="line862">To install MySQL server, install the <tt>mysql-server</tt> package. <span class="anchor" id="line-221"></span><span class="anchor" id="line-222"></span></p><p class="line867">
</p><h1 id="Installing_Packages_for_Client_Access_and_Authentication">Installing Packages for Client Access and Authentication</h1>
<span class="anchor" id="line-223"></span><span class="anchor" id="line-224"></span><p class="line874">We will need to offer our user IMAP/POP3 access. Our setup will offer those using the following packages. <span class="anchor" id="line-225"></span><span class="anchor" id="line-226"></span></p><p class="line862">To provide client authentication, install the <tt>courier-authdaemon</tt> package. <span class="anchor" id="line-227"></span><span class="anchor" id="line-228"></span></p><p class="line862">To add MySQL support for courier-authdaemon, install the <tt>courier-authmysql</tt> package. <span class="anchor" id="line-229"></span>On Ubuntu 7.10, courier-authmysql seems deprecated, install courier-authlib-mysql instead. <span class="anchor" id="line-230"></span><span class="anchor" id="line-231"></span></p><p class="line862">To provide unencrypted POP3 access, install the <tt>courier-pop</tt> package. <span class="anchor" id="line-232"></span><span class="anchor" id="line-233"></span></p><p class="line862">To provide SSL-encrypted POP3 access, install the <tt>courier-pop-ssl</tt> package. <span class="anchor" id="line-234"></span><span class="anchor" id="line-235"></span></p><p class="line862">To provide unencrypted IMAP access, install the <tt>courier-imap</tt> package. <span class="anchor" id="line-236"></span><span class="anchor" id="line-237"></span></p><p class="line862">To provide SSL-encrypted IMAP access , install the <tt>courier-imap-ssl</tt> package. <span class="anchor" id="line-238"></span><span class="anchor" id="line-239"></span><span class="anchor" id="line-240"></span></p><p class="line867">
</p><h1 id="Installing_package_for_SMTP_authentication">Installing package for SMTP authentication</h1>
<span class="anchor" id="line-241"></span><span class="anchor" id="line-242"></span><p class="line874">Our system will allow road-warriors to send email through our server using authenticated SMTP. This will basically stop unauthorized relaying through our mail server. Not only we are authenticating our user's when they are retrieving mails but also we authenticate them when they are sending mails as well. <span class="anchor" id="line-243"></span><span class="anchor" id="line-244"></span></p><p class="line862">To provide encrypted authenticated SMTP, install the <tt>postfix-tls</tt> package. <span class="anchor" id="line-245"></span><span class="anchor" id="line-246"></span></p><p class="line874">This may have already installed with postfix. If so,leave it. <span class="anchor" id="line-247"></span><span class="anchor" id="line-248"></span></p><p class="line862">To install Cyrus SASL library, install the <tt>libsasl2</tt> package. <span class="anchor" id="line-249"></span><span class="anchor" id="line-250"></span></p><p class="line862">To add authentication mechanisms for the SASL library, install the <tt>libsasl2-modules</tt> package. <span class="anchor" id="line-251"></span><span class="anchor" id="line-252"></span></p><p class="line862">To add MySQL support authentication mechanisms with the SASL library, install the <tt>libsasl2-modules-sql</tt> package. <span class="anchor" id="line-253"></span><span class="anchor" id="line-254"></span></p><p class="line862">To create certificates, install the <tt>openssl</tt> package. <span class="anchor" id="line-255"></span><span class="anchor" id="line-256"></span></p><p class="line867">
</p><h1 id="Setting_MySQL_Backend">Setting MySQL Backend</h1>
<span class="anchor" id="line-257"></span><span class="anchor" id="line-258"></span><p class="line874">Now that we have installed packages required to prepare a MySQL backend for Postfix.   In this section we will configure MySQL database for Postfix. <span class="anchor" id="line-259"></span><span class="anchor" id="line-260"></span></p><p class="line867">
</p><h2 id="Setting_MySQL_root_Password">Setting MySQL root Password</h2>
<span class="anchor" id="line-261"></span><span class="anchor" id="line-262"></span><p class="line874">Please note that MySQL root is different from Linux root account. It is the account   which which users can use to get administrative previlege with MySQL database sever. Initial installation of MySQL has no password fro root account. If you have not setup a password for MySQL root yet, this is the time for you to do so. There are few ways to do the same and I will present two of them here. Please user either one of them. <span class="anchor" id="line-263"></span><span class="anchor" id="line-264"></span></p><p class="line874">To set MySQL root in the command prompt: <span class="anchor" id="line-265"></span><span class="anchor" id="line-266"></span></p><p class="line867"><span class="anchor" id="line-267"></span><span class="anchor" id="line-268"></span></p><pre><span class="anchor" id="line-1-6"></span>$ sudo mysqladmin -u root password rootpassword</pre><span class="anchor" id="line-269"></span><span class="anchor" id="line-270"></span><p class="line874">or you can use the following steps to do the same <span class="anchor" id="line-271"></span><span class="anchor" id="line-272"></span></p><p class="line867"><span class="anchor" id="line-273"></span><span class="anchor" id="line-274"></span></p><pre><span class="anchor" id="line-1-7"></span>$ mysql -u root</pre><span class="anchor" id="line-275"></span><span class="anchor" id="line-276"></span><p class="line874">Then in the mysql prompt type: <span class="anchor" id="line-277"></span><span class="anchor" id="line-278"></span><span class="anchor" id="line-279"></span></p><p class="line867"><span class="anchor" id="line-280"></span><span class="anchor" id="line-281"></span></p><pre><span class="anchor" id="line-1-8"></span>mysql&gt; SET PASSWORD FOR 'root'@'localhost' = PASSWORD('rootpassword');</pre><span class="anchor" id="line-282"></span><span class="anchor" id="line-283"></span><p class="line862">Don't forget set a good password <strong>rootpassword</strong> <span class="anchor" id="line-284"></span><span class="anchor" id="line-285"></span></p><p class="line867">
</p><h2 id="Setting_MySQL_Database_for_Impatient_Users">Setting MySQL Database for Impatient Users</h2>
<span class="anchor" id="line-286"></span><span class="anchor" id="line-287"></span><p class="line874">The schema is based on the postfixadmin MySQL schema. If you are impatient you can directly create the tables using following steps. <span class="anchor" id="line-288"></span><span class="anchor" id="line-289"></span></p><p class="line867"><span class="anchor" id="line-290"></span><span class="anchor" id="line-291"></span></p><pre><span class="anchor" id="line-1-9"></span>$ editor postfixadmin-mysql.sql</pre><span class="anchor" id="line-292"></span><span class="anchor" id="line-293"></span><p class="line862">Then copy and paste the following script to the above file and save it. Replace <strong>postfixpassword</strong> on the <strong><tt>INSERT&nbsp;INTO&nbsp;user</tt></strong> line with a password of your choosing for the postfix user. Do the same for the postfixadmin password. <span class="anchor" id="line-294"></span><span class="anchor" id="line-295"></span></p><p class="line874">To create the database, type in a terminal. <span class="anchor" id="line-296"></span><span class="anchor" id="line-297"></span></p><p class="line867"><span class="anchor" id="line-298"></span><span class="anchor" id="line-299"></span></p><pre><span class="anchor" id="line-1-10"></span>$ mysql -u root -p &lt; postfixadmin-mysql.sql</pre><span class="anchor" id="line-300"></span><span class="anchor" id="line-301"></span><p class="line867"><span class="anchor" id="line-302"></span><span class="anchor" id="line-303"></span><span class="anchor" id="line-304"></span><span class="anchor" id="line-305"></span><span class="anchor" id="line-306"></span><span class="anchor" id="line-307"></span><span class="anchor" id="line-308"></span><span class="anchor" id="line-309"></span><span class="anchor" id="line-310"></span><span class="anchor" id="line-311"></span><span class="anchor" id="line-312"></span><span class="anchor" id="line-313"></span><span class="anchor" id="line-314"></span><span class="anchor" id="line-315"></span><span class="anchor" id="line-316"></span><span class="anchor" id="line-317"></span><span class="anchor" id="line-318"></span><span class="anchor" id="line-319"></span><span class="anchor" id="line-320"></span><span class="anchor" id="line-321"></span><span class="anchor" id="line-322"></span><span class="anchor" id="line-323"></span><span class="anchor" id="line-324"></span><span class="anchor" id="line-325"></span><span class="anchor" id="line-326"></span><span class="anchor" id="line-327"></span><span class="anchor" id="line-328"></span><span class="anchor" id="line-329"></span><span class="anchor" id="line-330"></span><span class="anchor" id="line-331"></span><span class="anchor" id="line-332"></span><span class="anchor" id="line-333"></span><span class="anchor" id="line-334"></span><span class="anchor" id="line-335"></span><span class="anchor" id="line-336"></span><span class="anchor" id="line-337"></span><span class="anchor" id="line-338"></span><span class="anchor" id="line-339"></span><span class="anchor" id="line-340"></span><span class="anchor" id="line-341"></span><span class="anchor" id="line-342"></span><span class="anchor" id="line-343"></span><span class="anchor" id="line-344"></span><span class="anchor" id="line-345"></span><span class="anchor" id="line-346"></span><span class="anchor" id="line-347"></span><span class="anchor" id="line-348"></span><span class="anchor" id="line-349"></span><span class="anchor" id="line-350"></span><span class="anchor" id="line-351"></span><span class="anchor" id="line-352"></span><span class="anchor" id="line-353"></span><span class="anchor" id="line-354"></span><span class="anchor" id="line-355"></span><span class="anchor" id="line-356"></span><span class="anchor" id="line-357"></span><span class="anchor" id="line-358"></span><span class="anchor" id="line-359"></span><span class="anchor" id="line-360"></span><span class="anchor" id="line-361"></span><span class="anchor" id="line-362"></span><span class="anchor" id="line-363"></span><span class="anchor" id="line-364"></span><span class="anchor" id="line-365"></span><span class="anchor" id="line-366"></span><span class="anchor" id="line-367"></span><span class="anchor" id="line-368"></span><span class="anchor" id="line-369"></span><span class="anchor" id="line-370"></span><span class="anchor" id="line-371"></span><span class="anchor" id="line-372"></span><span class="anchor" id="line-373"></span><span class="anchor" id="line-374"></span><span class="anchor" id="line-375"></span><span class="anchor" id="line-376"></span><span class="anchor" id="line-377"></span><span class="anchor" id="line-378"></span><span class="anchor" id="line-379"></span><span class="anchor" id="line-380"></span><span class="anchor" id="line-381"></span><span class="anchor" id="line-382"></span><span class="anchor" id="line-383"></span><span class="anchor" id="line-384"></span><span class="anchor" id="line-385"></span><span class="anchor" id="line-386"></span><span class="anchor" id="line-387"></span><span class="anchor" id="line-388"></span><span class="anchor" id="line-389"></span><span class="anchor" id="line-390"></span><span class="anchor" id="line-391"></span><span class="anchor" id="line-392"></span><span class="anchor" id="line-393"></span><span class="anchor" id="line-394"></span><span class="anchor" id="line-395"></span><span class="anchor" id="line-396"></span><span class="anchor" id="line-397"></span><span class="anchor" id="line-398"></span><span class="anchor" id="line-399"></span><span class="anchor" id="line-400"></span><span class="anchor" id="line-401"></span><span class="anchor" id="line-402"></span><span class="anchor" id="line-403"></span><span class="anchor" id="line-404"></span><span class="anchor" id="line-405"></span><span class="anchor" id="line-406"></span><span class="anchor" id="line-407"></span><span class="anchor" id="line-408"></span><span class="anchor" id="line-409"></span><span class="anchor" id="line-410"></span><span class="anchor" id="line-411"></span><span class="anchor" id="line-412"></span><span class="anchor" id="line-413"></span><span class="anchor" id="line-414"></span><span class="anchor" id="line-415"></span><span class="anchor" id="line-416"></span><span class="anchor" id="line-417"></span><span class="anchor" id="line-418"></span><span class="anchor" id="line-419"></span><span class="anchor" id="line-420"></span><span class="anchor" id="line-421"></span><span class="anchor" id="line-422"></span><span class="anchor" id="line-423"></span><span class="anchor" id="line-424"></span><span class="anchor" id="line-425"></span><span class="anchor" id="line-426"></span><span class="anchor" id="line-427"></span><span class="anchor" id="line-428"></span><span class="anchor" id="line-429"></span><span class="anchor" id="line-430"></span><span class="anchor" id="line-431"></span><span class="anchor" id="line-432"></span><span class="anchor" id="line-433"></span><span class="anchor" id="line-434"></span></p><pre><span class="anchor" id="line-1-11"></span>#------------------------------------Start copy-------------------------------------
<span class="anchor" id="line-2-2"></span>#
<span class="anchor" id="line-3-1"></span># Postfix Admin
<span class="anchor" id="line-4-1"></span># by Mischa Peters &lt;mischa at high5 dot net&gt;
<span class="anchor" id="line-5-1"></span># Copyright (c) 2002 - 2005 High5!
<span class="anchor" id="line-6-1"></span># License Info: http://www.postfixadmin.com/?file=LICENSE.TXT
<span class="anchor" id="line-7-1"></span>#
<span class="anchor" id="line-8-1"></span>
<span class="anchor" id="line-9"></span># This is the complete MySQL database structure for Postfix Admin.
<span class="anchor" id="line-10"></span># If you are installing from scratch you can use this file otherwise you
<span class="anchor" id="line-11"></span># need to use the TABLE_CHANGES.TXT or TABLE_BACKUP_MX.TXT that comes with Postfix Admin.
<span class="anchor" id="line-12"></span>#
<span class="anchor" id="line-13"></span># There are 2 entries for a database user in the file.
<span class="anchor" id="line-14"></span># One you can use for Postfix and one for Postfix Admin.
<span class="anchor" id="line-15"></span>#
<span class="anchor" id="line-16"></span># If you run this file twice (2x) you will get an error on the user creation in MySQL.
<span class="anchor" id="line-17"></span># To go around this you can either comment the lines below "USE MySQL" until "USE postfix".
<span class="anchor" id="line-18"></span># Or you can remove the users from the database and run it again.
<span class="anchor" id="line-19"></span>#
<span class="anchor" id="line-20"></span># You can create the database from the shell with:
<span class="anchor" id="line-21"></span>#
<span class="anchor" id="line-22"></span># mysql -u root [-p] &lt; DATABASE_MYSQL.TXT
<span class="anchor" id="line-23"></span>
<span class="anchor" id="line-24"></span>#
<span class="anchor" id="line-25"></span># Postfix / MySQL
<span class="anchor" id="line-26"></span>#
<span class="anchor" id="line-27"></span>CREATE DATABASE postfix;
<span class="anchor" id="line-28"></span>
<span class="anchor" id="line-29"></span>GRANT SELECT ON postfix.* TO postfix@localhost IDENTIFIED BY 'postfixpassword';
<span class="anchor" id="line-30"></span>GRANT SELECT, INSERT, DELETE, UPDATE ON postfix.* TO postfixadmin@localhost IDENTIFIED BY 'postfixadmin';
<span class="anchor" id="line-31"></span>
<span class="anchor" id="line-32"></span>USE postfix;
<span class="anchor" id="line-33"></span>#
<span class="anchor" id="line-34"></span># Table structure for table admin
<span class="anchor" id="line-35"></span>#
<span class="anchor" id="line-36"></span>CREATE TABLE admin (
<span class="anchor" id="line-37"></span>  username varchar(255) NOT NULL default '',
<span class="anchor" id="line-38"></span>  password varchar(255) NOT NULL default '',
<span class="anchor" id="line-39"></span>  created datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-40"></span>  modified datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-41"></span>  active tinyint(1) NOT NULL default '1',
<span class="anchor" id="line-42"></span>  PRIMARY KEY  (username),
<span class="anchor" id="line-43"></span>  KEY username (username)
<span class="anchor" id="line-44"></span>) COMMENT='Postfix Admin - Virtual Admins';
<span class="anchor" id="line-45"></span>
<span class="anchor" id="line-46"></span>#
<span class="anchor" id="line-47"></span># Table structure for table alias
<span class="anchor" id="line-48"></span>#
<span class="anchor" id="line-49"></span>CREATE TABLE alias (
<span class="anchor" id="line-50"></span>  address varchar(255) NOT NULL default '',
<span class="anchor" id="line-51"></span>  goto text NOT NULL,
<span class="anchor" id="line-52"></span>  domain varchar(255) NOT NULL default '',
<span class="anchor" id="line-53"></span>  created datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-54"></span>  modified datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-55"></span>  active tinyint(1) NOT NULL default '1',
<span class="anchor" id="line-56"></span>  PRIMARY KEY  (address),
<span class="anchor" id="line-57"></span>  KEY address (address)
<span class="anchor" id="line-58"></span>) COMMENT='Postfix Admin - Virtual Aliases';
<span class="anchor" id="line-59"></span>
<span class="anchor" id="line-60"></span>#
<span class="anchor" id="line-61"></span># Table structure for table domain
<span class="anchor" id="line-62"></span>#
<span class="anchor" id="line-63"></span>CREATE TABLE domain (
<span class="anchor" id="line-64"></span>  domain varchar(255) NOT NULL default '',
<span class="anchor" id="line-65"></span>  description varchar(255) NOT NULL default '',
<span class="anchor" id="line-66"></span>  aliases int(10) NOT NULL default '0',
<span class="anchor" id="line-67"></span>  mailboxes int(10) NOT NULL default '0',
<span class="anchor" id="line-68"></span>  maxquota int(10) NOT NULL default '0',
<span class="anchor" id="line-69"></span>  transport varchar(255) default NULL,
<span class="anchor" id="line-70"></span>  backupmx tinyint(1) NOT NULL default '0',
<span class="anchor" id="line-71"></span>  created datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-72"></span>  modified datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-73"></span>  active tinyint(1) NOT NULL default '1',
<span class="anchor" id="line-74"></span>  PRIMARY KEY  (domain),
<span class="anchor" id="line-75"></span>  KEY domain (domain)
<span class="anchor" id="line-76"></span>) COMMENT='Postfix Admin - Virtual Domains';
<span class="anchor" id="line-77"></span>
<span class="anchor" id="line-78"></span>#
<span class="anchor" id="line-79"></span># Table structure for table domain_admins
<span class="anchor" id="line-80"></span>#
<span class="anchor" id="line-81"></span>CREATE TABLE domain_admins (
<span class="anchor" id="line-82"></span>  username varchar(255) NOT NULL default '',
<span class="anchor" id="line-83"></span>  domain varchar(255) NOT NULL default '',
<span class="anchor" id="line-84"></span>  created datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-85"></span>  active tinyint(1) NOT NULL default '1',
<span class="anchor" id="line-86"></span>  KEY username (username)
<span class="anchor" id="line-87"></span>) COMMENT='Postfix Admin - Domain Admins';
<span class="anchor" id="line-88"></span>
<span class="anchor" id="line-89"></span>#
<span class="anchor" id="line-90"></span># Table structure for table log
<span class="anchor" id="line-91"></span>#
<span class="anchor" id="line-92"></span>CREATE TABLE log (
<span class="anchor" id="line-93"></span>  timestamp datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-94"></span>  username varchar(255) NOT NULL default '',
<span class="anchor" id="line-95"></span>  domain varchar(255) NOT NULL default '',
<span class="anchor" id="line-96"></span>  action varchar(255) NOT NULL default '',
<span class="anchor" id="line-97"></span>  data varchar(255) NOT NULL default '',
<span class="anchor" id="line-98"></span>  KEY timestamp (timestamp)
<span class="anchor" id="line-99"></span>) COMMENT='Postfix Admin - Log';
<span class="anchor" id="line-100"></span>
<span class="anchor" id="line-101"></span>#
<span class="anchor" id="line-102"></span># Table structure for table mailbox
<span class="anchor" id="line-103"></span>#
<span class="anchor" id="line-104"></span>CREATE TABLE mailbox (
<span class="anchor" id="line-105"></span>  username varchar(255) NOT NULL default '',
<span class="anchor" id="line-106"></span>  password varchar(255) NOT NULL default '',
<span class="anchor" id="line-107"></span>  name varchar(255) NOT NULL default '',
<span class="anchor" id="line-108"></span>  maildir varchar(255) NOT NULL default '',
<span class="anchor" id="line-109"></span>  quota int(10) NOT NULL default '0',
<span class="anchor" id="line-110"></span>  domain varchar(255) NOT NULL default '',
<span class="anchor" id="line-111"></span>  created datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-112"></span>  modified datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-113"></span>  active tinyint(1) NOT NULL default '1',
<span class="anchor" id="line-114"></span>  PRIMARY KEY  (username),
<span class="anchor" id="line-115"></span>  KEY username (username)
<span class="anchor" id="line-116"></span>) COMMENT='Postfix Admin - Virtual Mailboxes';
<span class="anchor" id="line-117"></span>
<span class="anchor" id="line-118"></span>#
<span class="anchor" id="line-119"></span># Table structure for table vacation
<span class="anchor" id="line-120"></span>#
<span class="anchor" id="line-121"></span>CREATE TABLE vacation (
<span class="anchor" id="line-122"></span>  email varchar(255) NOT NULL default '',
<span class="anchor" id="line-123"></span>  subject varchar(255) NOT NULL default '',
<span class="anchor" id="line-124"></span>  body text NOT NULL,
<span class="anchor" id="line-125"></span>  cache text NOT NULL,
<span class="anchor" id="line-126"></span>  domain varchar(255) NOT NULL default '',
<span class="anchor" id="line-127"></span>  created datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-128"></span>  active tinyint(1) NOT NULL default '1',
<span class="anchor" id="line-129"></span>  PRIMARY KEY  (email),
<span class="anchor" id="line-130"></span>  KEY email (email)
<span class="anchor" id="line-131"></span>) COMMENT='Postfix Admin - Virtual Vacation';
<span class="anchor" id="line-132"></span>#------------------------------------End copy-------------------------------------</pre><span class="anchor" id="line-435"></span><span class="anchor" id="line-436"></span><p class="line867">
</p><h2 id="Step_by_Step_Database_Setup">Step by Step Database Setup</h2>
<span class="anchor" id="line-437"></span><span class="anchor" id="line-438"></span><p class="line874">The users who are wish to setup database step by step can use the following steps and understand what table is using what purpose. <span class="anchor" id="line-439"></span><span class="anchor" id="line-440"></span></p><p class="line867">
</p><h3 id="Setting_up_Database.2C_Users.2C_and_Privileges">Setting up Database, Users, and Privileges</h3>
<span class="anchor" id="line-441"></span><p class="line874">Connect to MySQL database as root <span class="anchor" id="line-442"></span><span class="anchor" id="line-443"></span></p><p class="line867"><span class="anchor" id="line-444"></span><span class="anchor" id="line-445"></span></p><pre><span class="anchor" id="line-1-12"></span>$ mysql -u root -p</pre><span class="anchor" id="line-446"></span><span class="anchor" id="line-447"></span><p class="line874">Then execute the following SQL commands. <span class="anchor" id="line-448"></span><span class="anchor" id="line-449"></span></p><p class="line874">To create and use the database: <span class="anchor" id="line-450"></span><span class="anchor" id="line-451"></span></p><p class="line867"><span class="anchor" id="line-452"></span><span class="anchor" id="line-453"></span><span class="anchor" id="line-454"></span></p><pre><span class="anchor" id="line-1-13"></span>mysql&gt; CREATE DATABASE postfix;
<span class="anchor" id="line-2-3"></span>mysql&gt; USE postfix;</pre><span class="anchor" id="line-455"></span><span class="anchor" id="line-456"></span><p class="line862">To create Postfix user &amp; set password (replace <strong>postfixpassword</strong> with a password of your choosing): <span class="anchor" id="line-457"></span><span class="anchor" id="line-458"></span></p><p class="line867"><span class="anchor" id="line-459"></span><span class="anchor" id="line-460"></span></p><pre><span class="anchor" id="line-1-14"></span>mysql&gt; GRANT SELECT ON postfix.* TO postfix@localhost IDENTIFIED BY 'postfixpassword';</pre><span class="anchor" id="line-461"></span><span class="anchor" id="line-462"></span><p class="line862">To create Postfix Admin user &amp; set password (replace <strong>postfixadmin</strong> with a password of your choosing): <span class="anchor" id="line-463"></span><span class="anchor" id="line-464"></span></p><p class="line867"><span class="anchor" id="line-465"></span><span class="anchor" id="line-466"></span></p><pre><span class="anchor" id="line-1-15"></span>mysql&gt; GRANT SELECT, INSERT, DELETE, UPDATE ON postfix.* TO postfixadmin@localhost IDENTIFIED BY 'postfixadmin';</pre><span class="anchor" id="line-467"></span><span class="anchor" id="line-468"></span><p class="line867">
</p><h3 id="Create_the_Table_Admin">Create the Table Admin</h3>
<span class="anchor" id="line-469"></span><span class="anchor" id="line-470"></span><p class="line874">This table is used create the administrators for our virtual mail system. The admin user will be able create, modify, and delete virtadomain administrators, mailboxes and other administrative tasks in the mail system. Postfix is not using this table. <span class="anchor" id="line-471"></span><span class="anchor" id="line-472"></span></p><p class="line862">Copy and paste the sql statement to your <strong>mysql&gt;</strong> prompt. <span class="anchor" id="line-473"></span><span class="anchor" id="line-474"></span></p><p class="line867"><span class="anchor" id="line-475"></span><span class="anchor" id="line-476"></span><span class="anchor" id="line-477"></span><span class="anchor" id="line-478"></span><span class="anchor" id="line-479"></span><span class="anchor" id="line-480"></span><span class="anchor" id="line-481"></span><span class="anchor" id="line-482"></span><span class="anchor" id="line-483"></span><span class="anchor" id="line-484"></span></p><pre><span class="anchor" id="line-1-16"></span>CREATE TABLE admin (
<span class="anchor" id="line-2-4"></span>  username varchar(255) NOT NULL default '',
<span class="anchor" id="line-3-2"></span>  password varchar(255) NOT NULL default '',
<span class="anchor" id="line-4-2"></span>  created datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-5-2"></span>  modified datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-6-2"></span>  active tinyint(1) NOT NULL default '1',
<span class="anchor" id="line-7-2"></span>  PRIMARY KEY  (username),
<span class="anchor" id="line-8-2"></span>  KEY username (username)
<span class="anchor" id="line-9-1"></span>) COMMENT='Postfix Admin - Virtual Admins';</pre><span class="anchor" id="line-485"></span><span class="anchor" id="line-486"></span><p class="line867">
</p><h3 id="Create_the_Alias_table">Create the Alias table</h3>
<span class="anchor" id="line-487"></span><span class="anchor" id="line-488"></span><p class="line862">Postfix is using the <strong>"address"</strong> and <strong>"goto"</strong> column. Courier is not using this table. <span class="anchor" id="line-489"></span><span class="anchor" id="line-490"></span></p><div><table><tbody><tr>  <td><p class="line862"> <img alt="IconHint.png" class="attachment" src="postfixcompletevirtualmailsystemhowto_001.dat" title="IconHint.png"> </p></td>
  <td><p class="line862"> This table can be used for virtual .forward files. This table is nothing more than <strong><tt>/etc/aliases</tt></strong> that you will find on any *nix OS. Multiple destination email addresses need to be separated by a "," (comma).</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-491"></span><span class="anchor" id="line-492"></span><p class="line862">Following is the table structure for table alias. Copy and paste the sql statement to your <strong>mysql&gt;</strong> prompt <span class="anchor" id="line-493"></span><span class="anchor" id="line-494"></span></p><p class="line867"><span class="anchor" id="line-495"></span><span class="anchor" id="line-496"></span><span class="anchor" id="line-497"></span><span class="anchor" id="line-498"></span><span class="anchor" id="line-499"></span><span class="anchor" id="line-500"></span><span class="anchor" id="line-501"></span><span class="anchor" id="line-502"></span><span class="anchor" id="line-503"></span><span class="anchor" id="line-504"></span><span class="anchor" id="line-505"></span></p><pre><span class="anchor" id="line-1-17"></span>CREATE TABLE alias (
<span class="anchor" id="line-2-5"></span>  address varchar(255) NOT NULL default '',
<span class="anchor" id="line-3-3"></span>  goto text NOT NULL,
<span class="anchor" id="line-4-3"></span>  domain varchar(255) NOT NULL default '',
<span class="anchor" id="line-5-3"></span>  created datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-6-3"></span>  modified datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-7-3"></span>  active tinyint(1) NOT NULL default '1',
<span class="anchor" id="line-8-3"></span>  PRIMARY KEY  (address),
<span class="anchor" id="line-9-2"></span>  KEY address (address)
<span class="anchor" id="line-10-1"></span>) COMMENT='Postfix Admin - Virtual Aliases';</pre><span class="anchor" id="line-506"></span><span class="anchor" id="line-507"></span><p class="line867">
</p><h3 id="Create_the_Domain_table">Create the Domain table</h3>
<span class="anchor" id="line-508"></span><span class="anchor" id="line-509"></span><p class="line862">Postfix is using the <strong>"domain"</strong> and <strong>"description"</strong> column. Courier is not using this table. <span class="anchor" id="line-510"></span><span class="anchor" id="line-511"></span></p><p class="line862">Copy and paste the sql statement to your <strong>mysql&gt;</strong> prompt <span class="anchor" id="line-512"></span><span class="anchor" id="line-513"></span></p><p class="line867"><span class="anchor" id="line-514"></span><span class="anchor" id="line-515"></span><span class="anchor" id="line-516"></span><span class="anchor" id="line-517"></span><span class="anchor" id="line-518"></span><span class="anchor" id="line-519"></span><span class="anchor" id="line-520"></span><span class="anchor" id="line-521"></span><span class="anchor" id="line-522"></span><span class="anchor" id="line-523"></span><span class="anchor" id="line-524"></span><span class="anchor" id="line-525"></span><span class="anchor" id="line-526"></span><span class="anchor" id="line-527"></span><span class="anchor" id="line-528"></span><span class="anchor" id="line-529"></span></p><pre><span class="anchor" id="line-1-18"></span>CREATE TABLE domain (
<span class="anchor" id="line-2-6"></span>  domain varchar(255) NOT NULL default '',
<span class="anchor" id="line-3-4"></span>  description varchar(255) NOT NULL default '',
<span class="anchor" id="line-4-4"></span>  aliases int(10) NOT NULL default '0',
<span class="anchor" id="line-5-4"></span>  mailboxes int(10) NOT NULL default '0',
<span class="anchor" id="line-6-4"></span>  maxquota int(10) NOT NULL default '0',
<span class="anchor" id="line-7-4"></span>  transport varchar(255) default NULL,
<span class="anchor" id="line-8-4"></span>  backupmx tinyint(1) NOT NULL default '0',
<span class="anchor" id="line-9-3"></span>  created datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-10-2"></span>  modified datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-11-1"></span>  active tinyint(1) NOT NULL default '1',
<span class="anchor" id="line-12-1"></span>  PRIMARY KEY  (domain),
<span class="anchor" id="line-13-1"></span>  KEY domain (domain)
<span class="anchor" id="line-14-1"></span>) COMMENT='Postfix Admin - Virtual Domains';</pre><span class="anchor" id="line-530"></span><span class="anchor" id="line-531"></span><p class="line867">
</p><h3 id="Create_the_Domain_Admin_Table">Create the Domain Admin Table</h3>
<span class="anchor" id="line-532"></span><span class="anchor" id="line-533"></span><p class="line874">Table structure for table domain_admins. This table is used to create individual administrators for each virtual domain. Postfix or Courier is not using this table. <span class="anchor" id="line-534"></span><span class="anchor" id="line-535"></span></p><p class="line862">Copy and paste the sql statement to your <strong>mysql&gt;</strong> prompt. <span class="anchor" id="line-536"></span><span class="anchor" id="line-537"></span></p><p class="line867"><span class="anchor" id="line-538"></span><span class="anchor" id="line-539"></span><span class="anchor" id="line-540"></span><span class="anchor" id="line-541"></span><span class="anchor" id="line-542"></span><span class="anchor" id="line-543"></span><span class="anchor" id="line-544"></span><span class="anchor" id="line-545"></span></p><pre><span class="anchor" id="line-1-19"></span>CREATE TABLE domain_admins (
<span class="anchor" id="line-2-7"></span>  username varchar(255) NOT NULL default '',
<span class="anchor" id="line-3-5"></span>  domain varchar(255) NOT NULL default '',
<span class="anchor" id="line-4-5"></span>  created datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-5-5"></span>  active tinyint(1) NOT NULL default '1',
<span class="anchor" id="line-6-5"></span>  KEY username (username)
<span class="anchor" id="line-7-5"></span>) COMMENT='Postfix Admin - Domain Admins';</pre><span class="anchor" id="line-546"></span><span class="anchor" id="line-547"></span><p class="line867">
</p><h3 id="Create_the_Mailbox_Table">Create the Mailbox Table</h3>
<span class="anchor" id="line-548"></span><span class="anchor" id="line-549"></span><p class="line862">Postfix is using the <strong>"username"</strong> and <strong>"maildir"</strong> column while Courier is using the <strong>"username"</strong>, <strong>"password"</strong>, <strong>"name"</strong> and <strong>"maildir"</strong> column. <span class="anchor" id="line-550"></span><span class="anchor" id="line-551"></span></p><p class="line862">Copy and paste the sql statement to your <strong>mysql&gt;</strong> prompt. <span class="anchor" id="line-552"></span><span class="anchor" id="line-553"></span></p><p class="line867"><span class="anchor" id="line-554"></span><span class="anchor" id="line-555"></span><span class="anchor" id="line-556"></span><span class="anchor" id="line-557"></span><span class="anchor" id="line-558"></span><span class="anchor" id="line-559"></span><span class="anchor" id="line-560"></span><span class="anchor" id="line-561"></span><span class="anchor" id="line-562"></span><span class="anchor" id="line-563"></span><span class="anchor" id="line-564"></span><span class="anchor" id="line-565"></span><span class="anchor" id="line-566"></span><span class="anchor" id="line-567"></span></p><pre><span class="anchor" id="line-1-20"></span>CREATE TABLE mailbox (
<span class="anchor" id="line-2-8"></span>  username varchar(255) NOT NULL default '',
<span class="anchor" id="line-3-6"></span>  password varchar(255) NOT NULL default '',
<span class="anchor" id="line-4-6"></span>  name varchar(255) NOT NULL default '',
<span class="anchor" id="line-5-6"></span>  maildir varchar(255) NOT NULL default '',
<span class="anchor" id="line-6-6"></span>  quota int(10) NOT NULL default '0',
<span class="anchor" id="line-7-6"></span>  domain varchar(255) NOT NULL default '',
<span class="anchor" id="line-8-5"></span>  created datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-9-4"></span>  modified datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-10-3"></span>  active tinyint(1) NOT NULL default '1',
<span class="anchor" id="line-11-2"></span>  PRIMARY KEY  (username),
<span class="anchor" id="line-12-2"></span>  KEY username (username)
<span class="anchor" id="line-13-2"></span>) COMMENT='Postfix Admin - Virtual Mailboxes';</pre><span class="anchor" id="line-568"></span><span class="anchor" id="line-569"></span><p class="line867">
</p><h3 id="Create_the_Log_Table">Create the Log Table</h3>
<span class="anchor" id="line-570"></span><span class="anchor" id="line-571"></span><p class="line874">Postfix or Courier is not using this table. Instead this table is used to log the activities of domain administrators and mailbox users. <span class="anchor" id="line-572"></span><span class="anchor" id="line-573"></span></p><p class="line862">Copy and paste the sql statement to your <strong>mysql&gt;</strong> prompt. <span class="anchor" id="line-574"></span><span class="anchor" id="line-575"></span></p><p class="line867"><span class="anchor" id="line-576"></span><span class="anchor" id="line-577"></span><span class="anchor" id="line-578"></span><span class="anchor" id="line-579"></span><span class="anchor" id="line-580"></span><span class="anchor" id="line-581"></span><span class="anchor" id="line-582"></span><span class="anchor" id="line-583"></span><span class="anchor" id="line-584"></span></p><pre><span class="anchor" id="line-1-21"></span>CREATE TABLE log (
<span class="anchor" id="line-2-9"></span>  timestamp datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-3-7"></span>  username varchar(255) NOT NULL default '',
<span class="anchor" id="line-4-7"></span>  domain varchar(255) NOT NULL default '',
<span class="anchor" id="line-5-7"></span>  action varchar(255) NOT NULL default '',
<span class="anchor" id="line-6-7"></span>  data varchar(255) NOT NULL default '',
<span class="anchor" id="line-7-7"></span>  KEY timestamp (timestamp)
<span class="anchor" id="line-8-6"></span>) COMMENT='Postfix Admin - Log';</pre><span class="anchor" id="line-585"></span><span class="anchor" id="line-586"></span><p class="line867">
</p><h3 id="Create_the_Vacation_Table">Create the Vacation Table</h3>
<span class="anchor" id="line-587"></span><span class="anchor" id="line-588"></span><p class="line874">Virtual Vacation is done with a local shell account that can receive <span class="anchor" id="line-589"></span>email. The email is then handled by a Perl script which sends the Vacation <span class="anchor" id="line-590"></span>message back to the sender. <span class="anchor" id="line-591"></span><span class="anchor" id="line-592"></span></p><p class="line862">Copy and paste the sql statement to your <strong>mysql&gt;</strong> prompt. <span class="anchor" id="line-593"></span><span class="anchor" id="line-594"></span></p><p class="line867"><span class="anchor" id="line-595"></span><span class="anchor" id="line-596"></span><span class="anchor" id="line-597"></span><span class="anchor" id="line-598"></span><span class="anchor" id="line-599"></span><span class="anchor" id="line-600"></span><span class="anchor" id="line-601"></span><span class="anchor" id="line-602"></span><span class="anchor" id="line-603"></span><span class="anchor" id="line-604"></span><span class="anchor" id="line-605"></span><span class="anchor" id="line-606"></span></p><pre><span class="anchor" id="line-1-22"></span>CREATE TABLE vacation (
<span class="anchor" id="line-2-10"></span>  email varchar(255) NOT NULL default '',
<span class="anchor" id="line-3-8"></span>  subject varchar(255) NOT NULL default '',
<span class="anchor" id="line-4-8"></span>  body text NOT NULL,
<span class="anchor" id="line-5-8"></span>  cache text NOT NULL,
<span class="anchor" id="line-6-8"></span>  domain varchar(255) NOT NULL default '',
<span class="anchor" id="line-7-8"></span>  created datetime NOT NULL default '0000-00-00 00:00:00',
<span class="anchor" id="line-8-7"></span>  active tinyint(1) NOT NULL default '1',
<span class="anchor" id="line-9-5"></span>  PRIMARY KEY  (email),
<span class="anchor" id="line-10-4"></span>  KEY email (email)
<span class="anchor" id="line-11-3"></span>) COMMENT='Postfix Admin - Virtual Vacation';</pre><span class="anchor" id="line-607"></span><span class="anchor" id="line-608"></span><p class="line867">
</p><h3 id="Finish">Finish</h3>
<span class="anchor" id="line-609"></span><p class="line874">Disconnect from the MySQL database <span class="anchor" id="line-610"></span><span class="anchor" id="line-611"></span></p><p class="line867"><span class="anchor" id="line-612"></span><span class="anchor" id="line-613"></span></p><pre><span class="anchor" id="line-1-23"></span>mysql&gt; QUIT</pre><span class="anchor" id="line-614"></span><span class="anchor" id="line-615"></span><p class="line867">
</p><h1 id="Setting_Postfix_MySQL_Maps">Setting Postfix MySQL Maps</h1>
<span class="anchor" id="line-616"></span><span class="anchor" id="line-617"></span><p class="line874">As specified earlier in this document you need to tell Postfix where the control information is stored in the database. You need to create the following four text files in /etc/postfix for that reason. <span class="anchor" id="line-618"></span><span class="anchor" id="line-619"></span></p><p class="line862">Note that in the files we create below, we specify <tt>127.0.0.1</tt> for the <tt>hosts</tt> field instead of <tt>localhost</tt>. This is because Postfix is run in a chroot environment, and if you specify <tt>localhost</tt> Postfix will try to connct to the MySQL deamon using a unix socket in the directory /var/run/mysql, to which it will not have access. Using <tt>127.0.0.1</tt> forces Postfix to connect using a TCP/IP socket, which will work in the chroot environment. <span class="anchor" id="line-620"></span><span class="anchor" id="line-621"></span></p><div><table><tbody><tr>  <td><p class="line862"> <img alt="IconWarning.png" class="attachment" src="postfixcompletevirtualmailsystemhowto_002.dat" title="IconWarning.png"> </p></td>
  <td><p class="line862"> In all files below we use <tt>postfixpassword</tt> for the password field. You will want to change this password to one of your own choosing for security reasons. You will also not want to post these configuration files when asking for help on the forums without changing the password field for obvious reasons.</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-622"></span><span class="anchor" id="line-623"></span><p class="line867">
</p><h2 id="Creating_Virtual_Alias_Maps">Creating Virtual Alias Maps</h2>
<span class="anchor" id="line-624"></span><span class="anchor" id="line-625"></span><p class="line862">Postfix will use this file for Virtual Alias Maps and it will use The LHS of the mapping is defined as <strong>where_field</strong> and the RHS is defined as <strong>select_field</strong>. In this file it would be a mapping of the <strong>address</strong> column to the <strong>goto</strong> column. <span class="anchor" id="line-626"></span><span class="anchor" id="line-627"></span></p><p class="line867"><span class="anchor" id="line-628"></span><span class="anchor" id="line-629"></span></p><pre><span class="anchor" id="line-1-24"></span>$ sudo editor /etc/postfix/mysql_virtual_alias_maps.cf</pre><span class="anchor" id="line-630"></span><span class="anchor" id="line-631"></span><p class="line874">Then add the following code segment to the above file. <span class="anchor" id="line-632"></span><span class="anchor" id="line-633"></span></p><p class="line867"><span class="anchor" id="line-634"></span><span class="anchor" id="line-635"></span><span class="anchor" id="line-636"></span><span class="anchor" id="line-637"></span><span class="anchor" id="line-638"></span><span class="anchor" id="line-639"></span><span class="anchor" id="line-640"></span><span class="anchor" id="line-641"></span></p><pre><span class="anchor" id="line-1-25"></span>user = postfix
<span class="anchor" id="line-2-11"></span>password = postfixpassword
<span class="anchor" id="line-3-9"></span>hosts = 127.0.0.1
<span class="anchor" id="line-4-9"></span>dbname = postfix
<span class="anchor" id="line-5-9"></span>table = alias
<span class="anchor" id="line-6-9"></span>select_field = goto
<span class="anchor" id="line-7-9"></span>where_field = address</pre><span class="anchor" id="line-642"></span><span class="anchor" id="line-643"></span><p class="line867">
</p><h2 id="Virtual_Domain_Maps">Virtual Domain Maps</h2>
<span class="anchor" id="line-644"></span><span class="anchor" id="line-645"></span><p class="line874">Posfix is only using domain field from this table. For domains we do not need to map LHS and RHS. <span class="anchor" id="line-646"></span><span class="anchor" id="line-647"></span></p><p class="line867"><span class="anchor" id="line-648"></span><span class="anchor" id="line-649"></span></p><pre><span class="anchor" id="line-1-26"></span>$ sudo editor /etc/postfix/mysql_virtual_domains_maps.cf</pre><span class="anchor" id="line-650"></span><span class="anchor" id="line-651"></span><p class="line874">Then add the following code segment to the above file. <span class="anchor" id="line-652"></span><span class="anchor" id="line-653"></span></p><p class="line867"><span class="anchor" id="line-654"></span><span class="anchor" id="line-655"></span><span class="anchor" id="line-656"></span><span class="anchor" id="line-657"></span><span class="anchor" id="line-658"></span><span class="anchor" id="line-659"></span><span class="anchor" id="line-660"></span><span class="anchor" id="line-661"></span><span class="anchor" id="line-662"></span></p><pre><span class="anchor" id="line-1-27"></span>user = postfix
<span class="anchor" id="line-2-12"></span>password = postfixpassword
<span class="anchor" id="line-3-10"></span>hosts = 127.0.0.1
<span class="anchor" id="line-4-10"></span>dbname = postfix
<span class="anchor" id="line-5-10"></span>table = domain
<span class="anchor" id="line-6-10"></span>select_field = domain
<span class="anchor" id="line-7-10"></span>where_field = domain
<span class="anchor" id="line-8-8"></span>#additional_conditions = and backupmx = '0' and active = '1'</pre><span class="anchor" id="line-663"></span><span class="anchor" id="line-664"></span><p class="line867">
</p><h2 id="Virtual_Mailbox_Maps">Virtual Mailbox Maps</h2>
<span class="anchor" id="line-665"></span><span class="anchor" id="line-666"></span><p class="line862">Postfix will map <strong>username</strong> column with <strong>maildir</strong> querying mailbox table. <span class="anchor" id="line-667"></span><span class="anchor" id="line-668"></span></p><p class="line867"><span class="anchor" id="line-669"></span><span class="anchor" id="line-670"></span></p><pre><span class="anchor" id="line-1-28"></span>$ sudo editor /etc/postfix/mysql_virtual_mailbox_maps.cf</pre><span class="anchor" id="line-671"></span><span class="anchor" id="line-672"></span><p class="line874">Then add the following code segment to the above file. <span class="anchor" id="line-673"></span><span class="anchor" id="line-674"></span></p><p class="line867"><span class="anchor" id="line-675"></span><span class="anchor" id="line-676"></span><span class="anchor" id="line-677"></span><span class="anchor" id="line-678"></span><span class="anchor" id="line-679"></span><span class="anchor" id="line-680"></span><span class="anchor" id="line-681"></span><span class="anchor" id="line-682"></span><span class="anchor" id="line-683"></span></p><pre><span class="anchor" id="line-1-29"></span>user = postfix
<span class="anchor" id="line-2-13"></span>password = postfixpassword
<span class="anchor" id="line-3-11"></span>hosts = 127.0.0.1
<span class="anchor" id="line-4-11"></span>dbname = postfix
<span class="anchor" id="line-5-11"></span>table = mailbox
<span class="anchor" id="line-6-11"></span>select_field = maildir
<span class="anchor" id="line-7-11"></span>where_field = username
<span class="anchor" id="line-8-9"></span>#additional_conditions = and active = '1'</pre><span class="anchor" id="line-684"></span><span class="anchor" id="line-685"></span><p class="line867">
</p><h2 id="Virtual_Mailbox_Quota_Maps">Virtual Mailbox Quota Maps</h2>
<span class="anchor" id="line-686"></span><span class="anchor" id="line-687"></span><p class="line862">Postfix will this maps to handle the quota for virtual mailboxes. <strong>Username</strong> column will be mapped with the <strong>quota</strong> column in the <strong>mailbox</strong> table. <span class="anchor" id="line-688"></span><span class="anchor" id="line-689"></span></p><p class="line867"><span class="anchor" id="line-690"></span><span class="anchor" id="line-691"></span></p><pre><span class="anchor" id="line-1-30"></span>$ sudo editor /etc/postfix/mysql_virtual_mailbox_limit_maps.cf</pre><span class="anchor" id="line-692"></span><span class="anchor" id="line-693"></span><p class="line874">Then add the following code segment to the above file. <span class="anchor" id="line-694"></span><span class="anchor" id="line-695"></span></p><p class="line867"><span class="anchor" id="line-696"></span><span class="anchor" id="line-697"></span><span class="anchor" id="line-698"></span><span class="anchor" id="line-699"></span><span class="anchor" id="line-700"></span><span class="anchor" id="line-701"></span><span class="anchor" id="line-702"></span><span class="anchor" id="line-703"></span><span class="anchor" id="line-704"></span></p><pre><span class="anchor" id="line-1-31"></span>user = postfix
<span class="anchor" id="line-2-14"></span>password = postfixpassword
<span class="anchor" id="line-3-12"></span>hosts = 127.0.0.1
<span class="anchor" id="line-4-12"></span>dbname = postfix
<span class="anchor" id="line-5-12"></span>table = mailbox
<span class="anchor" id="line-6-12"></span>select_field = quota
<span class="anchor" id="line-7-12"></span>where_field = username
<span class="anchor" id="line-8-10"></span>#additional_conditions = and active = '1'</pre><span class="anchor" id="line-705"></span><span class="anchor" id="line-706"></span><p class="line867">
</p><h2 id="Relay_Domain_Maps">Relay Domain Maps</h2>
<span class="anchor" id="line-707"></span><span class="anchor" id="line-708"></span><p class="line874">If you are going to use your mail system only for hosting backup MX for some virtual  domains then you need this mapping to tell the Postfix to enable the relaying for these domains. <span class="anchor" id="line-709"></span><span class="anchor" id="line-710"></span></p><p class="line867"><span class="anchor" id="line-711"></span><span class="anchor" id="line-712"></span></p><pre><span class="anchor" id="line-1-32"></span>$ sudo editor /etc/postfix/mysql_relay_domains_maps.cf</pre><span class="anchor" id="line-713"></span><span class="anchor" id="line-714"></span><p class="line874">Then add the following code segment to the above file. <span class="anchor" id="line-715"></span><span class="anchor" id="line-716"></span></p><p class="line867"><span class="anchor" id="line-717"></span><span class="anchor" id="line-718"></span><span class="anchor" id="line-719"></span><span class="anchor" id="line-720"></span><span class="anchor" id="line-721"></span><span class="anchor" id="line-722"></span><span class="anchor" id="line-723"></span><span class="anchor" id="line-724"></span><span class="anchor" id="line-725"></span></p><pre><span class="anchor" id="line-1-33"></span>user = postfix
<span class="anchor" id="line-2-15"></span>password = postfixpassword
<span class="anchor" id="line-3-13"></span>hosts = 127.0.0.1
<span class="anchor" id="line-4-13"></span>dbname = postfix
<span class="anchor" id="line-5-13"></span>table = domain
<span class="anchor" id="line-6-13"></span>select_field = domain
<span class="anchor" id="line-7-13"></span>where_field = domain
<span class="anchor" id="line-8-11"></span>additional_conditions = and backupmx = '1'</pre><span class="anchor" id="line-726"></span><span class="anchor" id="line-727"></span><span class="anchor" id="line-728"></span><div><table><tbody><tr>  <td><p class="line891"><img alt="IconWarning.png" class="attachment" src="postfixcompletevirtualmailsystemhowto_002.dat" title="IconWarning.png"></p></td>
  <td><p class="line862">For security concerns you should let all these to be read by <strong>root</strong> only. If you let other users in the system to read these files, every body on your system can read the <strong>postfix</strong> database access password which is written in plain text and find out information about user accounts and alter them in the database. <strong>Dangerous!!!</strong>.</p></td>
</tr>
</tbody></table></div><span class="anchor" id="line-729"></span><span class="anchor" id="line-730"></span><p class="line874">Execute the following commands to make these file secure from others. <span class="anchor" id="line-731"></span><span class="anchor" id="line-732"></span></p><p class="line874">To set the group of these files to postfix: <span class="anchor" id="line-733"></span><span class="anchor" id="line-734"></span></p><p class="line867"><span class="anchor" id="line-735"></span><span class="anchor" id="line-736"></span></p><pre><span class="anchor" id="line-1-34"></span>$ sudo chgrp postfix /etc/postfix/mysql_*.cf</pre><span class="anchor" id="line-737"></span><span class="anchor" id="line-738"></span><p class="line874">To make the file readable by the group: <span class="anchor" id="line-739"></span><span class="anchor" id="line-740"></span></p><p class="line867"><span class="anchor" id="line-741"></span><span class="anchor" id="line-742"></span></p><pre><span class="anchor" id="line-1-35"></span>$ sudo chmod 640 /etc/postfix/mysql_*.cf</pre><span class="anchor" id="line-743"></span><span class="anchor" id="line-744"></span><p class="line867">
</p><h2 id="Create_a_vmail_user">Create a vmail user</h2>
<span class="anchor" id="line-745"></span><span class="anchor" id="line-746"></span><p class="line874">Our system can hold mailboxes for thousands of users. All of these users are virtual users and none of them is a Linux system user, hence these users can not store their mail in our system's hard disk. You probably do not want to assign a unique UID (user ID) to every user, so let's create a Linux user who will become the owner of all mailboxes. <span class="anchor" id="line-747"></span><span class="anchor" id="line-748"></span></p><p class="line867"><span class="anchor" id="line-749"></span><span class="anchor" id="line-750"></span><span class="anchor" id="line-751"></span></p><pre><span class="anchor" id="line-1-36"></span>$ sudo groupadd -g 5000 vmail
<span class="anchor" id="line-2-16"></span>$ sudo useradd -m -g vmail -u 5000 -d /home/vmail -s /bin/bash vmail</pre><span class="anchor" id="line-752"></span><span class="anchor" id="line-753"></span><p class="line867">
</p><h1 id="Configuring_Postfix_with_MySQL_maps">Configuring Postfix with MySQL maps</h1>
<span class="anchor" id="line-754"></span><span class="anchor" id="line-755"></span><p class="line862">We have already created our MySQL maps config files and now the time is to setup Postfix <strong>main.cf</strong> file so that Postfix can query MySQL database for virtual mailboxes and domains. <span class="anchor" id="line-756"></span><span class="anchor" id="line-757"></span></p><p class="line874">Open the main.cf file. <span class="anchor" id="line-758"></span><span class="anchor" id="line-759"></span></p><p class="line867"><span class="anchor" id="line-760"></span><span class="anchor" id="line-761"></span></p><pre><span class="anchor" id="line-1-37"></span>$ sudo editor /etc/postfix/main.cf</pre><span class="anchor" id="line-762"></span><span class="anchor" id="line-763"></span><p class="line874">Then add the following code segment to main.cf <span class="anchor" id="line-764"></span><span class="anchor" id="line-765"></span></p><p class="line867"><span class="anchor" id="line-766"></span><span class="anchor" id="line-767"></span><span class="anchor" id="line-768"></span><span class="anchor" id="line-769"></span><span class="anchor" id="line-770"></span><span class="anchor" id="line-771"></span><span class="anchor" id="line-772"></span><span class="anchor" id="line-773"></span><span class="anchor" id="line-774"></span><span class="anchor" id="line-775"></span><span class="anchor" id="line-776"></span><span class="anchor" id="line-777"></span><span class="anchor" id="line-778"></span><span class="anchor" id="line-779"></span><span class="anchor" id="line-780"></span><span class="anchor" id="line-781"></span><span class="anchor" id="line-782"></span><span class="anchor" id="line-783"></span><span class="anchor" id="line-784"></span><span class="anchor" id="line-785"></span><span class="anchor" id="line-786"></span></p><pre><span class="anchor" id="line-1-38"></span># Virtual Mailbox Domain Settings
<span class="anchor" id="line-2-17"></span>
<span class="anchor" id="line-3-14"></span>virtual_alias_maps = mysql:/etc/postfix/mysql_virtual_alias_maps.cf
<span class="anchor" id="line-4-14"></span>virtual_mailbox_domains = mysql:/etc/postfix/mysql_virtual_domains_maps.cf
<span class="anchor" id="line-5-14"></span>virtual_mailbox_maps = mysql:/etc/postfix/mysql_virtual_mailbox_maps.cf
<span class="anchor" id="line-6-14"></span>virtual_mailbox_limit = 51200000
<span class="anchor" id="line-7-14"></span>virtual_minimum_uid = 5000
<span class="anchor" id="line-8-12"></span>virtual_uid_maps = static:5000
<span class="anchor" id="line-9-6"></span>virtual_gid_maps = static:5000
<span class="anchor" id="line-10-5"></span>virtual_mailbox_base = /home/vmail
<span class="anchor" id="line-11-4"></span>virtual_transport = virtual
<span class="anchor" id="line-12-3"></span>
<span class="anchor" id="line-13-3"></span># Additional for quota support
<span class="anchor" id="line-14-2"></span>
<span class="anchor" id="line-15-1"></span>virtual_create_maildirsize = yes
<span class="anchor" id="line-16-1"></span>virtual_mailbox_extended = yes
<span class="anchor" id="line-17-1"></span>virtual_mailbox_limit_maps = mysql:/etc/postfix/mysql_virtual_mailbox_limit_maps.cf
<span class="anchor" id="line-18-1"></span>virtual_mailbox_limit_override = yes
<span class="anchor" id="line-19-1"></span>virtual_maildir_limit_message = Sorry, the your maildir has overdrawn your diskspace quota, please free up some of spaces of your mailbox try again.
<span class="anchor" id="line-20-1"></span>virtual_overquota_bounce = yes</pre><span class="anchor" id="line-787"></span><p class="line867">
</p><h1 id="Setting_up_Postfix">Setting up Postfix</h1>
<span class="anchor" id="line-788"></span><p class="line874">Postfix has several hundred configuration parameters that are controlled via the main.cf file. Fortunately, all parameters have sensible default values. We only have to define the following parameters <span class="anchor" id="line-789"></span><span class="anchor" id="line-790"></span><span class="anchor" id="line-791"></span></p><pre><span class="anchor" id="line-1-39"></span>$ sudo editor /etc/postfix/main.cf</pre><span class="anchor" id="line-792"></span><span class="anchor" id="line-793"></span><p class="line867"><span class="anchor" id="line-794"></span><span class="anchor" id="line-795"></span><span class="anchor" id="line-796"></span><span class="anchor" id="line-797"></span><span class="anchor" id="line-798"></span></p><pre><span class="anchor" id="line-1-40"></span>#The host name where your MX for virtual domains will point to
<span class="anchor" id="line-2-18"></span>myhostname = mail.domain.com  
<span class="anchor" id="line-3-15"></span>mydestination = #Remains blank since we are going to host virtual domains
<span class="anchor" id="line-4-15"></span>relayhost = #Remains blank unless you are going to use your ISP's SMTP server mail sending out mails. In which case it would be set to the host name of the ISP's SMTP server </pre><span class="anchor" id="line-799"></span><p class="line874">Leave the following to their default values <span class="anchor" id="line-800"></span><span class="anchor" id="line-801"></span><span class="anchor" id="line-802"></span><span class="anchor" id="line-803"></span><span class="anchor" id="line-804"></span><span class="anchor" id="line-805"></span><span class="anchor" id="line-806"></span><span class="anchor" id="line-807"></span><span class="anchor" id="line-808"></span></p><pre><span class="anchor" id="line-1-41"></span>alias_maps = hash:/etc/aliases
<span class="anchor" id="line-2-19"></span>alias_database = hash:/etc/aliases
<span class="anchor" id="line-3-16"></span>myorigin = /etc/mailname
<span class="anchor" id="line-4-16"></span>mynetworks = all
<span class="anchor" id="line-5-15"></span>mailbox_size_limit = 0
<span class="anchor" id="line-6-15"></span>recipient_delimiter = +
<span class="anchor" id="line-7-15"></span>inet_interfaces = all</pre><span class="anchor" id="line-809"></span><span class="anchor" id="line-810"></span><p class="line874">And set up permissions for postfix to use sasl, or you will get error: <span class="anchor" id="line-811"></span><strong>SASL authentication failure: cannot connect to saslauthd server: Permission denied</strong> <span class="anchor" id="line-812"></span><span class="anchor" id="line-813"></span><span class="anchor" id="line-814"></span></p><pre><span class="anchor" id="line-1-42"></span>usermod -G sasl postfix</pre><span class="anchor" id="line-815"></span><span class="anchor" id="line-816"></span><p class="line867">
</p><h1 id="Enhanced_Mail_Services">Enhanced Mail Services</h1>
<span class="anchor" id="line-817"></span><span class="anchor" id="line-818"></span><p class="line867">
</p><h2 id="Postfixadmin">Postfixadmin</h2>
<span class="anchor" id="line-819"></span><ul><li><p class="line862">download postfixadmin's debian package: <a class="http" href="http://postfixadmin.sourceforge.net/">http://postfixadmin.sourceforge.net/</a> <span class="anchor" id="line-820"></span></p></li><li>install package <span class="anchor" id="line-821"></span></li></ul><p class="line867"><span class="anchor" id="line-822"></span><span class="anchor" id="line-823"></span></p><pre><span class="anchor" id="line-1-43"></span>dpkg -i postfixadmin_2.2.1.1_all.deb  </pre><span class="anchor" id="line-824"></span><ul><li style="list-style-type: none;">Warning: this package does not contains mysql scripts. You could use one from the svn version. I hope this will be fixed soon in released 2.2. <span class="anchor" id="line-825"></span></li><li>setup databases  <span class="anchor" id="line-826"></span>(warning: it could overlapped databases created manualy before) <span class="anchor" id="line-827"></span></li></ul><p class="line867"><span class="anchor" id="line-828"></span><span class="anchor" id="line-829"></span></p><pre><span class="anchor" id="line-1-44"></span> http://localhost/postfixadmin/setup.php</pre><span class="anchor" id="line-830"></span><ul><li>restart apache2 <span class="anchor" id="line-831"></span></li></ul><p class="line867"><span class="anchor" id="line-832"></span><span class="anchor" id="line-833"></span></p><pre><span class="anchor" id="line-1-45"></span>/etc/init.d/apache2 restart</pre><span class="anchor" id="line-834"></span><ul><li>edit /usr/share/postfixadmin/config.inc.php and setup database password and set the flag "configured"=true <span class="anchor" id="line-835"></span></li><li><p class="line862">browse to <a class="http" href="http://localhost/postfixadmin">http://localhost/postfixadmin</a> <span class="anchor" id="line-836"></span></p></li><li>now you can add domains and mailboxes <span class="anchor" id="line-837"></span></li></ul><p class="line874">**TODO** rewrite this part with release 2.3 <span class="anchor" id="line-838"></span>
</p><h2 id="Courier-IMAP_and_Authentication_Services">Courier-IMAP and Authentication Services</h2>
<span class="anchor" id="line-839"></span><ul><li>In /etc/courier/authdaemonrc <span class="anchor" id="line-840"></span></li></ul><p class="line874">Change to mysql mode <span class="anchor" id="line-841"></span><span class="anchor" id="line-842"></span><span class="anchor" id="line-843"></span></p><pre><span class="anchor" id="line-1-46"></span>authmodulelist="authmysql"</pre><span class="anchor" id="line-844"></span><p class="line874">Also change DEBUG to <span class="anchor" id="line-845"></span><span class="anchor" id="line-846"></span><span class="anchor" id="line-847"></span></p><pre><span class="anchor" id="line-1-47"></span>DEBUG_LOGIN=2</pre><span class="anchor" id="line-848"></span><p class="line874">This will save you alot of time trying to debug while tailing /var/log/mail* <span class="anchor" id="line-849"></span><span class="anchor" id="line-850"></span></p><ul><li>In /etc/courier/authmysqlrc <span class="anchor" id="line-851"></span></li></ul><p class="line867"><span class="anchor" id="line-852"></span><span class="anchor" id="line-853"></span><span class="anchor" id="line-854"></span><span class="anchor" id="line-855"></span><span class="anchor" id="line-856"></span><span class="anchor" id="line-857"></span><span class="anchor" id="line-858"></span><span class="anchor" id="line-859"></span><span class="anchor" id="line-860"></span><span class="anchor" id="line-861"></span><span class="anchor" id="line-862"></span><span class="anchor" id="line-863"></span><span class="anchor" id="line-864"></span><span class="anchor" id="line-865"></span><span class="anchor" id="line-866"></span></p><pre><span class="anchor" id="line-1-48"></span>MYSQL_SERVER 127.0.0.1
<span class="anchor" id="line-2-20"></span>MYSQL_USERNAME postfix
<span class="anchor" id="line-3-17"></span>MYSQL_PASSWORD thepassword
<span class="anchor" id="line-4-17"></span>MYSQL_DATABASE postfix
<span class="anchor" id="line-5-16"></span>MYSQL_USER_TABLE mailbox
<span class="anchor" id="line-6-16"></span>MYSQL_LOGIN_FIELD username
<span class="anchor" id="line-7-16"></span>MYSQL_NAME_FIELD name
<span class="anchor" id="line-8-13"></span>MYSQL_CRYPT_PWFIELD password
<span class="anchor" id="line-9-7"></span>#MYSQL_CLEAR_PWFIELD     password
<span class="anchor" id="line-10-6"></span>MYSQL_MAILDIR_FIELD maildir
<span class="anchor" id="line-11-5"></span>MYSQL_QUOTA_FIELD concat(quota,'S')
<span class="anchor" id="line-12-4"></span>MYSQL_HOME_FIELD        '/home/vmail'
<span class="anchor" id="line-13-4"></span>MYSQL_UID_FIELD '5000'
<span class="anchor" id="line-14-3"></span>MYSQL_GID_FIELD '5000'</pre><span class="anchor" id="line-867"></span><ul><li>Restart daemons and checks logs: <span class="anchor" id="line-868"></span></li></ul><p class="line867"><span class="anchor" id="line-869"></span><span class="anchor" id="line-870"></span><span class="anchor" id="line-871"></span></p><pre><span class="anchor" id="line-1-49"></span> /etc/init.d/courier-authdaemon restart ; /etc/init.d/courier-imap restart; /etc/init.d/courier-pop restart
<span class="anchor" id="line-2-21"></span> tail -f /var/log/mail*</pre><span class="anchor" id="line-872"></span><p class="line867">
</p><h2 id="SMTP_Authentication">SMTP Authentication</h2>
<span class="anchor" id="line-873"></span><p class="line862">A good documentation : <a class="http" href="http://www.starbridge.org/spip/spip.php?article1">http://www.starbridge.org/spip/spip.php?article1</a> <span class="anchor" id="line-874"></span><span class="anchor" id="line-875"></span><span class="anchor" id="line-876"></span></p><p class="line874">Note to all users: <span class="anchor" id="line-877"></span><span class="anchor" id="line-878"></span></p><ul><li style="list-style-type: none;">Changed do to postfix error: inet is not a smtpd_recipient_restriction <span class="anchor" id="line-879"></span>Any users that have used this before please remove inet from this setting <span class="anchor" id="line-880"></span><ul><li style="list-style-type: none;">or postfix will not work <span class="anchor" id="line-881"></span><span class="anchor" id="line-882"></span></li></ul></li></ul><p class="line874">#smtpd_recipient_restrictions = reject_unauth_pipelining, permit_mynetworks, permit_sasl_authenticated, reject_non_fqdn_recipient, reject_unknown_recipient_domain reject_unauth_destination, check_policy_service inet:127.0.0.1:10023, permit <span class="anchor" id="line-883"></span><span class="anchor" id="line-884"></span><span class="anchor" id="line-885"></span></p><p class="line874">In /etc/postfix/main.cf add <span class="anchor" id="line-886"></span><span class="anchor" id="line-887"></span><span class="anchor" id="line-888"></span><span class="anchor" id="line-889"></span><span class="anchor" id="line-890"></span><span class="anchor" id="line-891"></span><span class="anchor" id="line-892"></span><span class="anchor" id="line-893"></span><span class="anchor" id="line-894"></span><span class="anchor" id="line-895"></span><span class="anchor" id="line-896"></span></p><pre><span class="anchor" id="line-1-50"></span>smtpd_recipient_restrictions = reject_unauth_pipelining, permit_mynetworks, permit_sasl_authenticated, reject_non_fqdn_recipient, reject_unknown_recipient_domain reject_unauth_destination, check_policy_service inet:127.0.0.1:10023, permit
<span class="anchor" id="line-2-22"></span># modify the existing smtpd_sender_restrictions
<span class="anchor" id="line-3-18"></span>smtpd_sender_restrictions = permit_sasl_authenticated, permit_mynetworks, reject_non_fqdn_sender, reject_unknown_sender_domain, reject_unauth_pipelining, permit
<span class="anchor" id="line-4-18"></span># then add these
<span class="anchor" id="line-5-17"></span>smtpd_sasl_auth_enable = yes
<span class="anchor" id="line-6-17"></span>broken_sasl_auth_clients = yes
<span class="anchor" id="line-7-17"></span>smtpd_sasl_security_options = noanonymous
<span class="anchor" id="line-8-14"></span>smtpd_sasl_local_domain =</pre><span class="anchor" id="line-897"></span><p class="line874">In /etc/postfix/sasl/smtpd.conf <span class="anchor" id="line-898"></span><span class="anchor" id="line-899"></span><span class="anchor" id="line-900"></span><span class="anchor" id="line-901"></span><span class="anchor" id="line-902"></span><span class="anchor" id="line-903"></span><span class="anchor" id="line-904"></span><span class="anchor" id="line-905"></span><span class="anchor" id="line-906"></span><span class="anchor" id="line-907"></span><span class="anchor" id="line-908"></span></p><pre><span class="anchor" id="line-1-51"></span>pwcheck_method: auxprop
<span class="anchor" id="line-2-23"></span>auxprop_plugin: sql
<span class="anchor" id="line-3-19"></span>mech_list: plain login cram-md5 digest-md5
<span class="anchor" id="line-4-19"></span>sql_engine: mysql
<span class="anchor" id="line-5-18"></span>sql_hostnames: 127.0.0.1
<span class="anchor" id="line-6-18"></span>sql_user: postfix
<span class="anchor" id="line-7-18"></span>sql_passwd: yourpassword
<span class="anchor" id="line-8-15"></span>sql_database: postfix
<span class="anchor" id="line-9-8"></span>sql_select: select password from mailbox where username='%u@%r' and active = 1</pre><span class="anchor" id="line-909"></span><p class="line867">
</p><h2 id="Web_Access">Web Access</h2>
<span class="anchor" id="line-910"></span><p class="line867"><a class="nonexistent" href="https://help.ubuntu.com/community/SquirrelMail">SquirrelMail</a> is a standards-based webmail package written in PHP. It includes built-in pure PHP support for the IMAP and SMTP protocols, and all pages render in pure HTML 4.0 (with no <a class="nonexistent" href="https://help.ubuntu.com/community/JavaScript">JavaScript</a> required) for maximum compatibility across browsers. It has very few requirements and is very easy to configure and install. <a class="nonexistent" href="https://help.ubuntu.com/community/SquirrelMail">SquirrelMail</a> has all the functionality you would want from an email client, including strong MIME support, address books, and folder manipulation. <span class="anchor" id="line-911"></span>SUORCE: <a class="nonexistent" href="https://help.ubuntu.com/community/SquirrelMail">SquirrelMail</a> home page <span class="anchor" id="line-912"></span><span class="anchor" id="line-913"></span><span class="anchor" id="line-914"></span></p><pre><span class="anchor" id="line-1-52"></span>$ sudo apt-get install squirrelmail</pre><span class="anchor" id="line-915"></span><p class="line867">
</p><h2 id="Refining_the_Setup">Refining the Setup</h2>
<span class="anchor" id="line-916"></span><span class="anchor" id="line-917"></span><p class="line867">
</p><h1 id="Anti-Spam_Configuration">Anti-Spam Configuration</h1>
<span class="anchor" id="line-918"></span><span class="anchor" id="line-919"></span><p class="line867">
</p><h2 id="Installing_Amavisd_and_Spamassassin">Installing Amavisd and Spamassassin</h2>
<span class="anchor" id="line-920"></span><p class="line867">
</p><h2 id="Quarantine_and_Spam_Management">Quarantine and Spam Management</h2>
<span class="anchor" id="line-921"></span><p class="line867">
</p><h2 id="Auto_and_Per-Recipient_White.2BAC8-Black_Lists">Auto and Per-Recipient White/Black Lists</h2>
<span class="anchor" id="line-922"></span><p class="line867">
</p><h2 id="Amavis.2BAC8-Spamassassin_UI">Amavis/Spamassassin UI</h2>
<span class="anchor" id="line-923"></span><p class="line867">
</p><h2 id="GreyListing">GreyListing</h2>
<span class="anchor" id="line-924"></span><p class="line867">
</p><h2 id="Distributed_and_Collaborative_Networks">Distributed and Collaborative Networks</h2>
<span class="anchor" id="line-925"></span><span class="anchor" id="line-926"></span><p class="line867">
</p><h1 id="Anti-Virus_Configuration">Anti-Virus Configuration</h1>
<span class="anchor" id="line-927"></span><span class="anchor" id="line-928"></span><p class="line867">
</p><h2 id="Configuring_for_ClamAV">Configuring for ClamAV</h2>
<span class="anchor" id="line-929"></span><span class="anchor" id="line-930"></span><p class="line867">
</p><h1 id="Log_Analyzer">Log Analyzer</h1>
<span class="anchor" id="line-931"></span><span class="anchor" id="line-932"></span><p class="line867">
</p><h2 id="Install_and_Configure_AWStats">Install and Configure AWStats</h2>
<span class="anchor" id="line-933"></span><span class="anchor" id="line-934"></span><p class="line867">
</p><h1 id="Wrapping_it_Up">Wrapping it Up</h1>
<span class="anchor" id="line-935"></span><span class="anchor" id="line-936"></span><p class="line867">
</p><h1 id="Final_Changes_and_Troubleshooting">Final Changes and Troubleshooting</h1>
<span class="anchor" id="line-937"></span><span class="anchor" id="line-938"></span><p class="line867">
</p><h1 id="Other_links">Other links</h1>
<span class="anchor" id="line-939"></span><p class="line874">Until this article will be finished, you can find very similiar one here: <span class="anchor" id="line-940"></span><span class="anchor" id="line-941"></span></p><ul><li style="list-style-type: none;"><p class="line891"><a class="http" href="http://flurdy.com/docs/postfix">http://flurdy.com/docs/postfix</a> created by Ivar Abrahamsen <span class="anchor" id="line-942"></span><span class="anchor" id="line-943"></span></p></li></ul><p class="line862">Howto created by: <a class="nonexistent" href="https://help.ubuntu.com/community/ChinthakaDeshapriya">ChinthakaDeshapriya</a>. <span class="anchor" id="line-944"></span><span class="anchor" id="bottom"></span></p></div><p id="pageinfo" class="info" dir="ltr" lang="en">PostfixCompleteVirtualMailSystemHowto  (last edited 2010-10-08 16:35:43 by <span title="https://login.launchpad.net/+id/d4WzpCx @ pcsgw.pcservices.co.za[196.1.63.62]"><a class="interwiki" href="https://launchpad.net/%7EJohan%20Meiring" title="https://login.launchpad.net/+id/d4WzpCx @ pcsgw.pcservices.co.za[196.1.63.62]">Johan Meiring</a></span>)</p>

<ul class="pagelinks">
<li><a class="nbinfo" href="https://help.ubuntu.com/community/PostfixCompleteVirtualMailSystemHowto?action=info" rel="nofollow">Page History</a></li>
</ul>

<div id="pagebottom"></div>
</div>


<div id="footer">
<hr width="550px">

  <div id="ubuntulinks">
	<p>
	      The material on this wiki is available under a free license, see <a href="https://help.ubuntu.com/community/License">Copyright / License</a> for details<br><b>You</b> can contribute to this wiki, see <a href="https://help.ubuntu.com/community/WikiGuide">Wiki Guide</a> for details
	</p><br>
  </div>





</div> <!-- footer -->
</div> <!-- layout -->
<img id="bottomcap" alt="" src="cap-bottom.png">
</div> <!-- round -->



</body>
</html>
